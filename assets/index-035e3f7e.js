var e=Object.defineProperty,t=(t,s,i)=>(((t,s,i)=>{s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i})(t,"symbol"!=typeof s?s+"":s,i),i);!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const s={},i=function(e,t,i){if(!t||0===t.length)return e();const n=document.getElementsByTagName("link");return Promise.all(t.map((e=>{if((e=function(e){return"/schmupinator/"+e}(e))in s)return;s[e]=!0;const t=e.endsWith(".css"),a=t?'[rel="stylesheet"]':"";if(i)for(let s=n.length-1;s>=0;s--){const i=n[s];if(i.href===e&&(!t||"stylesheet"===i.rel))return}else if(document.querySelector(`link[href="${e}"]${a}`))return;const o=document.createElement("link");return o.rel=t?"stylesheet":"modulepreload",t||(o.as="script",o.crossOrigin=""),o.href=e,document.head.appendChild(o),t?new Promise(((t,s)=>{o.addEventListener("load",t),o.addEventListener("error",(()=>s(new Error(`Unable to preload CSS for ${e}`))))})):void 0}))).then((()=>e())).catch((e=>{const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}))},n=()=>"undefined"!=typeof window,a=n()?new class{constructor(){t(this,"WithWindow",(e=>e(window))),t(this,"Alert",(e=>{window.alert(e)})),t(this,"PerformanceNow",(()=>window.performance.now())),t(this,"SetInterval",((e,t)=>window.setInterval(e,t))),t(this,"RequestAnimationFrame",(e=>window.requestAnimationFrame(e))),t(this,"FetchText",(async e=>{const t=await window.fetch(e);return await t.text()})),t(this,"FetchBinary",(async e=>{const t=await window.fetch(e);return await t.blob()})),t(this,"SaveFile",(async(e,t)=>{}))}OnLoad(e){const t=new FontFace("PixelMicro",'url("/schmupinator/assets/PixelMicro-e7fba2b6.ttf")');t.load().then((()=>{document.fonts.add(t),e()})).catch((()=>{a.Alert("Failed to load PixelMicro font."),e()}))}}:new class{constructor(){t(this,"WithWindow",(e=>{})),t(this,"Alert",(e=>{throw console.log(e),new Error(e)})),t(this,"PerformanceNow",(()=>Date.now())),t(this,"SetInterval",((e,t)=>{for(let s=0;s<1e7;s++)e();return 0})),t(this,"RequestAnimationFrame",(e=>{for(let t=0;t<1e7;t++)e(0);return 0})),t(this,"FetchText",(async e=>{const{readFile:t}=await i((()=>import("./__vite-browser-external-afb87ea8.js")),[]);return(await t(e)).toString()})),t(this,"FetchBinary",(async e=>{const{readFile:t}=await i((()=>import("./__vite-browser-external-afb87ea8.js")),[]);let s;try{s=await t(e)}catch(n){s=await t("."+e)}return s})),t(this,"SaveFile",(async(e,t)=>{const{writeFile:s}=await i((()=>import("./__vite-browser-external-afb87ea8.js")),[]);s(e,t,(e=>{if(e)throw e;console.log("File saved.")}))}))}OnLoad(e){e()}};class o{constructor(e){for(t(this,"radians");e<0;)e+=2*Math.PI;for(;e>=2*Math.PI;)e-=2*Math.PI;this.radians=e}static fromRadians(e){return new o(e)}static fromDegrees(e){const t=e*(Math.PI/180);return new o(t)}get degrees(){return this.radians*(180/Math.PI)}add(e){return o.fromRadians(this.radians+e.radians)}subtract(e){return o.fromRadians(this.radians-e.radians)}invert(){return o.fromRadians(-this.radians)}}class r{constructor(e,s){t(this,"x"),t(this,"y"),t(this,"inSameDirection",(e=>this.dot(e)>0)),t(this,"antiClockwiseAngleTo",(e=>o.fromRadians(e.angle.radians-this.angle.radians))),t(this,"leftOf",(e=>e.antiClockwiseAngleTo(this).degrees<180)),t(this,"clone",(()=>new r(this.x,this.y))),this.x=e,this.y=s}static fromTo(e,t){const s=t.x-e.x,i=t.y-e.y;return new r(s,i)}get length(){return(this.x**2+this.y**2)**.5}rotateClockwise(e){const t=this.x,s=this.y,i=e.radians,n=Math.cos(i)*t-Math.sin(i)*s,a=Math.sin(i)*t+Math.cos(i)*s;return new r(n,a)}rotateClockwiseAroundVector(e,t){return this.subtract(t).rotateClockwise(e).add(t)}setLength(e){if(0===this.length)return console.warn("Trying to set length of a vector with zero length"),new r(0,e);const t=e/this.length,s=this.x*t,i=this.y*t;return new r(s,i)}dot(e){return this.x*e.x+this.y*e.y}projectOn(e){const t=this.dot(e)/e.length;return e.setLength(t)}add(e){return new r(this.x+e.x,this.y+e.y)}subtract(e){return new r(this.x-e.x,this.y-e.y)}scale(e){const t=this.x*e,s=this.y*e;return new r(t,s)}get angle(){return o.fromRadians(Math.atan2(this.y,this.x)+Math.PI/2)}static sum(e){const{x:t,y:s}=e.reduce(((e,t)=>(e.x+=t.x,e.y+=t.y,e)),{x:0,y:0});return new r(t,s)}static merge(e){return r.sum(e).scale(1/e.length)}merge(e,t){return this.scale(1-t).add(e.scale(t))}rotateClockwiseM(e){const t=this.x,s=this.y,i=e.radians;return this.x=Math.cos(i)*t-Math.sin(i)*s,this.y=Math.sin(i)*t+Math.cos(i)*s,this}}class h{}t(h,"Repeat",(function*({makeGenerator:e,times:t}){for(let s=0;s<t;s++)yield*e()})),t(h,"parallelRace",(function*(e){let t=e.map((e=>e.next()));for(;!t.some((e=>e.done));)yield,t=e.map((e=>e.next()))})),t(h,"parallelAll",(function*(e){let t=e.map((e=>e.next()));for(;!t.every((e=>e.done));)yield,t=e.map((e=>e.next()))}));const l=357,c=240,p=1e3/60,d=[2.35],m="2";class u{constructor(e){t(this,"input"),t(this,"gamepad"),t(this,"actionHandler"),t(this,"enemy"),t(this,"generators"),t(this,"ExecuteOneAction",(e=>{const t=this.makeGenerator([e]),{done:s}=t.next();return!!s})),t(this,"shootPressed",(()=>this.input.ButtonsPressed.shoot||this.gamepad.shoot)),t(this,"laserPressed",(()=>this.input.ButtonsPressed.laser||this.gamepad.laser)),t(this,"getAttribute",(e=>this.enemy.enemies.attributes.getAttribute({gameObjectId:e.gameObjectId??this.enemy.id,attribute:e.attribute})));const{actions:s,actionHandler:i,enemy:n,input:a,gamepad:o}=e;this.actionHandler=i,this.enemy=n,this.input=a,this.gamepad=o,this.generators=[this.makeGenerator(s)]}ProgressOneFrame(){const e=this.generators.length,t=this.generators.map((e=>e.next()));return e===this.generators.length&&t.every((e=>e.done))}*makeGenerator(e=[]){let t=0;const s=e.length;for(;t<s;){const s=e[t];switch(s.type){case"moveAccordingToInput":{const e=this.input,t=this.gamepad;let s=d[0];const i=e.ButtonsPressed.left||t.left,n=e.ButtonsPressed.right||t.right,a=e.ButtonsPressed.up||t.up,o=e.ButtonsPressed.down||t.down;(i||n)&&(a||o)&&(s/=Math.SQRT2);let r=0,h=0;i&&(r-=s),n&&(r+=s),a&&(h-=s),o&&(h+=s),0===r&&0===h||this.actionHandler({type:"moveDelta",x:r,y:h});break}case"waitInputShoot":{const e=()=>this.shootPressed()&&!this.laserPressed();for(;!e();)yield;break}case"waitInputLaser":{const e=()=>this.laserPressed();for(;!e();)yield;break}case"waitUntilAttrIs":{const{gameObjectId:e,attr:t,is:i}=s;for(;this.getAttribute({gameObjectId:e,attribute:t})!==i;)yield;break}case"fork":{const e=this.makeGenerator(s.actions);this.generators.push(e),e.next();break}case"do":yield*this.makeGenerator(s.acns);break;case"parallelRace":{const e=s.actionsLists.map((e=>this.makeGenerator(e)));yield*h.parallelRace(e);break}case"parallelAll":{const e=s.actionsLists.map((e=>this.makeGenerator(e)));yield*h.parallelAll(e);break}case"repeat":yield*h.Repeat({makeGenerator:()=>this.makeGenerator(s.actions),times:s.times});break;case"attrIs":{const{attrName:e,gameObjectId:t,is:i,yes:n,no:a}=s,o=this.getAttribute({gameObjectId:t,attribute:e});yield*this.makeGenerator(o===i?n:a);break}case"waitNextFrame":yield;break;case"wait":for(let e=0;e<s.frames;e++)yield;break;case"waitTilInsideScreen":{const e=0,t=-e,s=l+e,i=-e,n=c+e,a=({x:e,y:a})=>e<t||e>s||a<i||a>n;for(;a(this.enemy.getPosition());)yield;break}case"waitTilOutsideScreen":{const e=-30,t=387,s=-30,i=270,n=({x:n,y:a})=>n<e||n>t||a<s||a>i;for(;!n(this.enemy.getPosition());)yield;break}case"move":{const e=s.x??0,t=s.y??0,i=e/s.frames,n=t/s.frames;for(let a=1;a<=s.frames;a++)this.actionHandler({type:"moveDelta",x:i,y:n}),yield;break}case"moveToAbsolute":{const e=this.enemy.getPosition(),{moveTo:t}=s,i=void 0!==t.x?t.x-e.x:0,n=void 0!==t.y?t.y-e.y:0,a=i/s.frames,o=n/s.frames;for(let r=1;r<=s.frames;r++)this.actionHandler({type:"moveDelta",x:a,y:o}),yield;break}case"rotate_around_relative_point":{const e=s.point.x??0,t=s.point.y??0,i=new r(-e,-t);yield*y(s,i,this.actionHandler);break}case"rotate_around_absolute_point":{const e=this.enemy.getPosition(),t=s.point.x??e.x,i=s.point.y??e.y,n=r.fromTo(new r(t,i),new r(e.x,e.y));yield*y(s,n,this.actionHandler);break}default:this.actionHandler(s)}t++}}}const y=function*(e,t,s){const i=e.degrees/e.frames;for(let n=1;n<=e.frames;n++){const e=i*(n-1),a=i*n,h=t.rotateClockwise(o.fromDegrees(e)),l=t.rotateClockwise(o.fromDegrees(a)),c=r.fromTo(h,l);s({type:"moveDelta",x:c.x,y:c.y}),yield}},g=class e{constructor(e){t(this,"vector");const s=e.length;if(0===s)return void(this.vector=new r(0,1));const i=1/s,n=e.x*i,a=e.y*i;this.vector=new r(n,a)}get x(){return this.vector.x}get y(){return this.vector.y}rotateClockwise(t){const s=this.vector.x,i=this.vector.y,n=t.radians,a=Math.cos(n)*s-Math.sin(n)*i,o=Math.sin(n)*s+Math.cos(n)*i;return new e(new r(a,o))}toVector(){return new r(this.vector.x,this.vector.y)}static merge(t){const s=t.map((e=>e.toVector())),i=r.sum(s);return new e(i)}toVectorM(){return this.vector}};t(g,"normalFromPositions",((e,t)=>{const s=r.fromTo(e,t);return new g(s).rotateClockwise(o.fromDegrees(90))}));let v=g;const f={},x=e=>{const t=f[e]||0,s=t+1;return f[e]=s,t},b=e=>"object"==typeof e,w=e=>"number"==typeof e,S=e=>{if(!w(e)){const t=`assertNumber: ${JSON.stringify(e)} is not of type "number"`;throw a.Alert(t),new Error(t)}return e};class I{constructor(e){t(this,"graphics"),t(this,"gfxHandle"),t(this,"setPosition",(({x:e,y:t})=>{this.graphics.Dispatch({type:"gfxSetPosition",handle:this.gfxHandle,x:e,y:t})})),t(this,"release",(()=>{this.graphics.Dispatch({type:"gfxRelease",handle:this.gfxHandle})})),t(this,"setRotation",(({degrees:e})=>{this.graphics.Dispatch({type:"gfxSetRotation",handle:this.gfxHandle,degrees:e})})),t(this,"dispatch",(e=>{switch(e.type){case"gfxSetColor":case"gfxSetDiameter":case"gfxSetPosition":case"gfxSetRotation":case"gfxSetShape":case"gfxSetScale":case"gfxScrollBg":case"gfxFillScreen":this.graphics.Dispatch({...e,handle:this.gfxHandle});break;default:a.Alert(`${e.type} not handled in EnemyGfx.dispatch!\nThe full offending action:\n${JSON.stringify(e,null,2)}`)}}));const{graphics:s,x:i,y:n,diameter:o}=e;this.graphics=s,this.gfxHandle=this.graphics.Dispatch({type:"gfxAskForElement"}).handle,this.graphics.Dispatch({type:"gfxSetPosition",handle:this.gfxHandle,x:i,y:n}),this.graphics.Dispatch({type:"gfxSetDiameter",handle:this.gfxHandle,diameter:o}),this.graphics.Dispatch({type:"gfxSetColor",handle:this.gfxHandle,color:"red"}),this.graphics.Dispatch({type:"gfxSetShape",handle:this.gfxHandle,shape:"diamondShield"})}}class E{constructor(e,s,i){t(this,"X"),t(this,"Y"),t(this,"id"),t(this,"enemies"),t(this,"graphics"),t(this,"diameter"),t(this,"speed",0),t(this,"shotSpeed",.2),t(this,"moveDirection",new v(new r(0,1))),t(this,"mirrorX",!1),t(this,"mirrorY",!1),t(this,"actionExecutor"),t(this,"gfx"),t(this,"name"),t(this,"onDeathAction"),t(this,"OnFrameTick",(()=>{var e,t;this.actionExecutor.ProgressOneFrame(),this.attrs.getAttribute({gameObjectId:this.id,attribute:"boundToWindow"})&&this.boundToWindow(),null==(e=this.gfx)||e.setPosition({x:this.X,y:this.Y}),null==(t=this.gfx)||t.setRotation({degrees:this.moveDirection.toVector().angle.degrees})})),t(this,"OnCollision",(()=>{const e=S(this.attrs.getAttribute({gameObjectId:this.id,attribute:"points"}));this.enemies.eventsPoints.dispatchEvent({type:"add_points",points:e,enemy:this.name}),this.hp-=1,this.hp<1&&this.die()})),t(this,"boundToWindow",(()=>{const e=this.diameter/2;this.X<e?this.X=e:this.X>l-e&&(this.X=l-e),this.Y<e?this.Y=e:this.Y>c-e&&(this.Y=c-e)})),t(this,"despawn",(()=>{const e=this.enemies;e.enemies=e.enemies.filter((e=>e.id!==this.id));const t=S(this.attrs.getAttribute({gameObjectId:this.id,attribute:"pointsOnDeath"}));0!==t&&this.enemies.eventsPoints.dispatchEvent({type:"add_points",enemy:this.name,points:t}),this.gfx&&(this.gfx.release(),this.gfx=void 0),this!==this.enemies.player||this.enemies.settings.settings.invincibility||this.enemies.events.dispatchEvent({type:"player_died"})})),t(this,"die",(()=>{this===this.enemies.player&&this.enemies.settings.settings.invincibility||(this.onDeathAction&&(this.actionExecutor.ExecuteOneAction(this.onDeathAction)||a.Alert(`Enemy '${this.id}'s onDeathAction required more than 1 frame to execute.\n               An onDeathAction must be able to finish execution after 1 frame.`)),this.despawn())})),t(this,"HandleAction",(e=>{var t;switch(e.type){case"shootDirection":this.ShootDirection({dirX:e.x,dirY:e.y});break;case"setSpeed":this.speed=e.pixelsPerFrame;break;case"setShotSpeed":this.shotSpeed=e.pixelsPerFrame;break;case"set_position":this.SetPosition({x:e.x,y:e.y});break;case"shoot_toward_player":this.ShootTowardPlayer();break;case"shoot_beside_player":this.ShootBesidePlayer(e.degrees);break;case"rotate_towards_player":this.RotateTowardsPlayer();break;case"setMoveDirection":this.setMoveDirection(e.degrees);break;case"move_according_to_speed_and_direction":this.moveAccordingToSpeedAndDirection();break;case"spawn":{const{enemy:t,x:s=0,y:i=0,actions:n}=e;this.spawn({enemy:t,pos:{x:s,y:i},actions:n});break}case"mirrorX":this.mirrorX=e.value;break;case"mirrorY":this.mirrorY=e.value;break;case"moveDelta":this.moveDelta({x:e.x,y:e.y});break;case"setAttribute":{const{gameObjectId:t,attribute:s,value:i}=e;this.attrs.setAttribute({gameObjectId:t??this.id,attribute:s,value:i});break}case"despawn":this.despawn();break;case"die":this.die();break;case"incr":{const{gameObjectId:t,attribute:s}=e;this.attrs.incr({gameObjectId:t??this.id,attribute:s});break}case"decr":{const{gameObjectId:t,attribute:s}=e;this.attrs.decr({gameObjectId:t??this.id,attribute:s});break}case"finishLevel":this.enemies.events.dispatchEvent({type:"player_died"});break;default:null==(t=this.gfx)||t.dispatch(e)}})),t(this,"moveDelta",(({x:e=0,y:t=0})=>{this.X=this.mirrorX?this.X-e:this.X+e,this.Y=this.mirrorY?this.Y-t:this.Y+t})),t(this,"ShootDirection",(({dirX:e,dirY:t})=>{const s=0===e&&0===t,i=this.shotSpeed/(s?9999:Math.sqrt(e**2+t**2));this.spawn({enemy:"shot",pos:{x:0,y:0},actions:[{type:"fork",actions:[{type:"repeat",times:99999,actions:[{type:"moveDelta",x:e*i,y:t*i},{type:"waitNextFrame"}]}]}]})})),t(this,"ShootTowardPlayer",(()=>{const e=this.enemies.player,t=e.X-this.X,s=e.Y-this.Y;this.ShootDirection({dirX:t,dirY:s})})),t(this,"ShootBesidePlayer",(e=>{const t=this.enemies.player,s=t.X-this.X,i=t.Y-this.Y,n=new r(s,i).rotateClockwiseM(o.fromDegrees(e));this.ShootDirection({dirX:n.x,dirY:n.y})})),t(this,"SetPosition",(({x:e,y:t})=>{const s=this.getPosition(),i=new r(s.x,s.y),n=new r(e,t),a=r.fromTo(i,n);let o=a.x,h=a.y;this.mirrorX&&(o=-o),this.mirrorY&&(h=-h);const l=this.X+o,c=this.Y+h;this.X=l,this.Y=c})),t(this,"RotateTowardsPlayer",(()=>{const e=this.enemies.player,t=new r(e.X,e.Y),s=new r(this.X,this.Y),i=r.fromTo(s,t);this.moveDirection=new v(i)})),t(this,"setMoveDirection",(e=>{const t=new v(new r(0,-1)).rotateClockwise(o.fromDegrees(e));this.moveDirection=t})),t(this,"moveAccordingToSpeedAndDirection",(()=>{const e=this.X+this.moveDirection.x*this.speed,t=this.Y+=this.moveDirection.y*this.speed;this.X=e,this.Y=t})),t(this,"spawn",(({enemy:e,pos:t,actions:s})=>{const i={x:t.x+this.X,y:t.y+this.Y};this.enemies.Spawn({enemy:e,position:i,prependActions:s})})),t(this,"getPosition",(()=>{let e=this.X,t=this.Y;return this.mirrorX&&(e=l-e),this.mirrorY&&(t=c-t),{x:e,y:t}})),this.enemies=e,this.id=`${i.name}-${x(i.name)}`,this.name=i.name,this.diameter=i.diameter,this.X=s.x,this.Y=s.y,this.actionExecutor=new u({actionHandler:this.HandleAction,actions:i.actions,enemy:this,input:this.enemies.input,gamepad:this.enemies.gamepad}),this.onDeathAction=i.onDeathAction,this.hp=i.hp,this.maxHp=i.hp,this.graphics=this.enemies.graphics,this.gfx=new I({diameter:i.diameter,graphics:this.graphics,x:this.X,y:this.Y})}get attrs(){return this.enemies.attributes}get hp(){return S(this.attrs.getAttribute({gameObjectId:this.id,attribute:"hp"}))}set hp(e){this.attrs.setAttribute({gameObjectId:this.id,attribute:"hp",value:e})}get maxHp(){return S(this.attrs.getAttribute({gameObjectId:this.id,attribute:"maxHp"}))}set maxHp(e){this.attrs.setAttribute({gameObjectId:this.id,attribute:"maxHp",value:e})}get Radius(){return this.diameter/2}}class k{constructor({name:e}){t(this,"name"),t(this,"enemies"),t(this,"memoizedPlayer"),t(this,"gameData"),t(this,"events"),t(this,"eventsCollisions"),t(this,"eventsPoints"),t(this,"graphics"),t(this,"input"),t(this,"gamepad"),t(this,"settings"),t(this,"attributes"),t(this,"Init",(async e=>{this.events=null==e?void 0:e.events,this.eventsCollisions=null==e?void 0:e.eventsCollisions,this.eventsPoints=null==e?void 0:e.eventsPoints,this.gameData=null==e?void 0:e.gameData,this.graphics=null==e?void 0:e.graphics,this.input=null==e?void 0:e.input,this.gamepad=null==e?void 0:e.gamepad,this.settings=null==e?void 0:e.settings,this.attributes=null==e?void 0:e.attributes,this.events.subscribeToEvent(this.name,this.handleEvent),this.eventsCollisions.subscribeToEvent(this.name,this.handleEvent)})),t(this,"Spawn",(({enemy:e,position:t,prependActions:s=[]})=>{const i=this.gameData.GetEnemy(e),n={...i,actions:[{type:"setAttribute",attribute:"points",value:10},{type:"setAttribute",attribute:"pointsOnDeath",value:0},{type:"setAttribute",attribute:"collisionType",value:"enemy"},{type:"setAttribute",attribute:"boundToWindow",value:!1},{type:"fork",actions:[{type:"waitTilInsideScreen"},{type:"waitTilOutsideScreen"},{type:"despawn"}]},...s,...i.actions]},a=new E(this,t,n);this.enemies.push(a),a.OnFrameTick()})),t(this,"handleEvent",(e=>{switch(e.type){case"frame_tick":1===e.frameNr&&this.Spawn({enemy:"spawner",position:{x:0,y:0}}),this.enemies.forEach((e=>{e.OnFrameTick()}));break;case"collisions":e.collisions.enemiesThatWereHit.forEach((e=>{const t=this.enemies.find((t=>t.id===e));t&&t.OnCollision()}))}})),this.name=e,this.enemies=[]}get player(){if(void 0!==this.memoizedPlayer)return this.memoizedPlayer;const e=this.enemies.find((e=>"player"===this.attributes.getAttribute({gameObjectId:e.id,attribute:"collisionType"})));if(void 0===e)throw new Error("Enemies.getPlayer: Player was not found");return this.memoizedPlayer=e,e}}const A=e=>`${e}px`;class D{constructor({app:e,name:s}){t(this,"app"),t(this,"name"),t(this,"startTime"),t(this,"framCounterDiv"),t(this,"elapsedTimeDiv"),t(this,"fpsDiv"),t(this,"maxWebWorkers"),t(this,"Init",(async()=>{this.app.events.subscribeToEvent(this.name,this.handleEvent),this.elapsedTimeDiv&&(this.elapsedTimeDiv.innerHTML="elapsed: 0s"),this.framCounterDiv&&(this.framCounterDiv.innerHTML="frames: 0"),this.fpsDiv&&(this.fpsDiv.innerHTML="fps: 0"),a.WithWindow((e=>{const t=e.navigator.hardwareConcurrency;this.maxWebWorkers&&(this.maxWebWorkers.innerHTML=`maxWebWorkers: ${t}`)}))})),t(this,"destroy",(()=>{var e,t,s,i;this.app.events.unsubscribeToEvent(this.name),this.startTime=null,null==(e=this.framCounterDiv)||e.remove(),this.framCounterDiv=void 0,null==(t=this.elapsedTimeDiv)||t.remove(),this.elapsedTimeDiv=void 0,null==(s=this.fpsDiv)||s.remove(),this.fpsDiv=void 0,null==(i=this.maxWebWorkers)||i.remove(),this.maxWebWorkers=void 0})),t(this,"handleEvent",(e=>{if("frame_tick"!==e.type)return;null===this.startTime&&(this.startTime=a.PerformanceNow());const t=a.PerformanceNow()-this.startTime,s=e.frameNr;this.elapsedTimeDiv&&(this.elapsedTimeDiv.innerHTML=`elapsed: ${((e,t=1)=>Math.round(e*10**t)/10**t)(t/1e3)}s`),this.framCounterDiv&&(this.framCounterDiv.innerHTML=`frames: ${s}`),this.fpsDiv&&(this.fpsDiv.innerHTML=`fps: ${Math.round(s/(t/1e3))}`)})),this.name=s,this.startTime=null,this.app=e,this.framCounterDiv=a.WithWindow((e=>{const t=e.document.createElement("div");return t.style.position="fixed",t.style.top=A(c),t.style.left="5px",t.style.zIndex=m,e.document.body.appendChild(t),t})),this.elapsedTimeDiv=a.WithWindow((e=>{const t=e.document.createElement("div");return t.style.position="fixed",t.style.top=A(c),t.style.left="75px",t.style.zIndex=m,e.document.body.appendChild(t),t})),this.fpsDiv=a.WithWindow((e=>{const t=e.document.createElement("div");return t.style.position="fixed",t.style.top=A(c),t.style.left="155px",t.style.zIndex=m,e.document.body.appendChild(t),t})),this.maxWebWorkers=a.WithWindow((e=>{const t=e.document.createElement("div");return t.style.position="fixed",t.style.top=A(c),t.style.left="223px",t.style.zIndex=m,e.document.body.appendChild(t),t}))}}class T{constructor({name:e}){t(this,"events"),t(this,"name"),t(this,"history"),t(this,"buttonsPressed",{start:!1,shoot:!1,laser:!1,left:!1,right:!1,up:!1,down:!1}),t(this,"onKeyUpCallback"),t(this,"frameCount",0),t(this,"Init",(async e=>{this.events=null==e?void 0:e.events,this.events.subscribeToEvent(this.name,(e=>{switch(e.type){case"frame_tick":this.frameCount=e.frameNr;break;case"player_died":console.log("Input.history:"),console.log(this.history)}}))})),t(this,"handleKey",((e,t)=>{switch(e.keyCode){case 13:return this.buttonsPressed.start=t,"start";case 32:return this.buttonsPressed.shoot=t,"shoot";case 17:return this.buttonsPressed.laser=t,"laser";case 37:return this.buttonsPressed.left=t,"left";case 38:return this.buttonsPressed.up=t,"up";case 39:return this.buttonsPressed.right=t,"right";case 40:return this.buttonsPressed.down=t,"down";default:return}})),t(this,"handleKeyDown",(e=>{this.handleKey(e,!0)})),t(this,"handleKeyUp",(e=>{var t;const s=this.handleKey(e,!1);void 0!==s&&(null==(t=this.onKeyUpCallback)||t.call(this,s))})),this.name=e,this.history={inputs:{},score:0},a.WithWindow((e=>{e.document.onkeydown=this.handleKeyDown,e.document.onkeyup=this.handleKeyUp}))}get ButtonsPressed(){const e=this.frameCount,t={...this.buttonsPressed};return Object.values(t).includes(!0)&&(Object.keys(t).forEach((e=>{"laser"!==e&&"shoot"!==e&&"up"!==e&&"down"!==e&&"left"!==e&&"right"!==e&&"start"!==e||!1===t[e]&&delete t[e]})),this.history.inputs[e]=t),this.buttonsPressed}}class C{constructor(e){t(this,"name"),t(this,"Init",(async()=>{})),t(this,"getPressedButton",(e=>!!n()&&a.WithWindow((t=>{var s,i;const n=t.navigator.getGamepads();if(n.length<1)return!1;const a=n[0];return!!a&&!!(null==(i=null==(s=a.buttons)?void 0:s[e])?void 0:i.pressed)})))),this.name=e.name,a.WithWindow((e=>{e.addEventListener("gamepadconnected",(function(e){console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",e.gamepad.index,e.gamepad.id,e.gamepad.buttons.length,e.gamepad.axes.length)}))}))}get shoot(){return this.getPressedButton(0)}get laser(){return this.getPressedButton(1)}get left(){return this.getPressedButton(14)}get right(){return this.getPressedButton(15)}get up(){return this.getPressedButton(12)}get down(){return this.getPressedButton(13)}}class P{constructor(e){t(this,"name"),t(this,"accumulatedTime",0),t(this,"events"),t(this,"eventsCollisions"),t(this,"enemies"),t(this,"attributes"),t(this,"Init",(async e=>{this.events=null==e?void 0:e.events,this.eventsCollisions=null==e?void 0:e.eventsCollisions,this.enemies=null==e?void 0:e.enemies,this.attributes=null==e?void 0:e.attributes,this.events.subscribeToEvent(this.name,(({type:e})=>{"frame_tick"===e&&this.update()}))})),t(this,"update",(()=>{const e=a.PerformanceNow(),t=[],s=[],i=[];this.enemies.enemies.forEach((e=>{switch(this.attributes.getAttribute({gameObjectId:e.id,attribute:"collisionType"})){case"enemy":t.push(e);break;case"enemyBullet":s.push(e);break;case"playerBullet":i.push(e)}}));const n=[...s,...t],o=this.enemies.player;if(this.calcCollisions({doesThis:o,collideWithThese:n}).collided){const e={enemiesThatWereHit:[o.id]};this.eventsCollisions.dispatchEvent({type:"collisions",collisions:e})}const r=t.reduce(((e,t)=>{const s=this.calcCollisions({doesThis:t,collideWithThese:i});return s.collided?[...e,t.id,s.collidedWithId]:e}),[]),h=a.PerformanceNow();if(this.accumulatedTime+=h-e,r.length>0){const e={enemiesThatWereHit:r};this.eventsCollisions.dispatchEvent({type:"collisions",collisions:e})}})),t(this,"calcCollisions",(e=>{const{doesThis:t,collideWithThese:s}=e;for(const i of s){const e=t.Radius+.8*i.Radius,s=t.X-i.X,n=t.Y-i.Y;if(Math.sqrt(s**2+n**2)<=e)return{collided:!0,collidedWithId:i.id}}return{collided:!1}})),this.name=e.name}}class F{constructor({app:e,name:s}){t(this,"app"),t(this,"name"),t(this,"subscribers"),t(this,"Init",(async()=>{})),t(this,"subscribeToEvent",((e,t)=>{this.subscribers[e]=t})),t(this,"unsubscribeToEvent",(e=>{delete this.subscribers[e]})),t(this,"dispatchEvent",(e=>{Object.values(this.subscribers).forEach((t=>{t(e)}))})),this.app=e,this.name=s,this.subscribers={}}}const _={largest:45,large:40,normal:30,small:27,smaller:23,smallest:18};class M{constructor(e){t(this,"element"),t(this,"destroy",(()=>{this.element.remove()}));const{text:s,onClick:i=null,fontSize:n=_.smallest,left:o=0,top:r=0,padding:h="3px 5px"}=e;this.element=a.WithWindow((e=>{const t=e.document.createElement("button");return t.style.position="fixed",t.style.top=A(r),t.style.left=A(o),t.style.fontSize=A(n),t.style.whiteSpace="pre",t.style.padding=h,t.style.zIndex=m,t.innerHTML=s,t.onclick=i,e.document.body.appendChild(t),t}))}}class O{constructor(){t(this,"destroyables",[]),t(this,"add",(e=>{this.destroyables.push(e)})),t(this,"destroy",(()=>{0===this.destroyables.length&&console.warn("Destroyable.destroy: no IDestroyable:s to destroy since this.destroyables is empty."),this.destroyables.forEach((e=>{e.destroy()}))}))}}class G{constructor({name:e}){t(this,"name"),t(this,"destroyables"),t(this,"gameLoop"),t(this,"settings"),t(this,"createIncrFrameButton",(e=>{const{frames:t,left:s}=e,i=new M({text:`+${t}`,left:s,top:295,onClick:()=>{for(let e=0;e<t;e++)this.gameLoop.nextFrame()}});this.destroyables.add(i)})),t(this,"createFrameMultiplierButton",(e=>{const{multiplier:t,left:s}=e,i=new M({text:`${t}x`,left:s,top:319,onClick:()=>{this.gameLoop.frameSpeedMultiplier=t}});this.destroyables.add(i)})),t(this,"Init",(async e=>{this.gameLoop=null==e?void 0:e.gameLoop,this.settings=null==e?void 0:e.settings,this.render()})),t(this,"destroy",(()=>{this.destroyables.destroy()})),t(this,"render",(()=>{this.createIncrFrameButton({left:5,frames:1}),this.createIncrFrameButton({left:31,frames:2}),this.createIncrFrameButton({left:57,frames:5}),this.createIncrFrameButton({left:83,frames:10}),this.createIncrFrameButton({left:115,frames:100}),this.createFrameMultiplierButton({left:5,multiplier:0}),this.createFrameMultiplierButton({left:32,multiplier:1}),this.createFrameMultiplierButton({left:59,multiplier:2}),this.createFrameMultiplierButton({left:86,multiplier:3}),this.createFrameMultiplierButton({left:113,multiplier:4}),this.createFrameMultiplierButton({left:140,multiplier:5});const{skipStartMenu:e}=this.settings.settings;this.destroyables.add(new M({text:e?"unskip start menu":"skip start menu",left:5,top:270,onClick:()=>{this.settings.toggleSetting("skipStartMenu"),this.refresh()}}))})),t(this,"refresh",(()=>{this.destroy(),this.render()})),this.name=e,this.destroyables=new O}}class W{constructor({app:e,name:s}){t(this,"app"),t(this,"name"),t(this,"points"),t(this,"Init",(async()=>{this.app.events.subscribeToEvent(this.name,this.onEvent),this.app.eventsPoints.subscribeToEvent(this.name,this.onEvent)})),t(this,"onEvent",(e=>{switch(e.type){case"add_points":this.points+=e.points,this.updatePoints();break;case"player_died":this.app.events.unsubscribeToEvent(this.name)}})),t(this,"updatePoints",(()=>{this.app.eventsUi.dispatchEvent({type:"uiScoreUpdated",points:this.points})})),this.app=e,this.name=s,this.points=0}}const L="__highscore",H=(e,{is:t,yes:s,no:i})=>({type:"attrIs",attrName:e,is:t,yes:s,no:i}),$=(...e)=>({type:"repeat",times:1e8,actions:e}),B=(...e)=>({type:"fork",actions:e}),N=({x:e,y:t,frames:s})=>({type:"moveToAbsolute",moveTo:{x:e,y:t},frames:s}),j=(...e)=>({type:"parallelAll",actionsLists:e.map((e=>Array.isArray(e)?e:[e]))}),U=(...e)=>({type:"parallelRace",actionsLists:e.map((e=>Array.isArray(e)?e:[e]))}),R=(e,t)=>({type:"repeat",times:e,actions:t}),X=e=>({type:"setSpeed",pixelsPerFrame:e}),z=(e,t)=>({type:"spawn",enemy:e,x:null==t?void 0:t.x,y:null==t?void 0:t.y,actions:null==t?void 0:t.actions}),Y=e=>({type:"setShotSpeed",pixelsPerFrame:e}),q=(...e)=>R(2,e),V=e=>({type:"wait",frames:e}),K={name:"explosion",diameter:18,hp:9999,actions:[{type:"setAttribute",attribute:"collisionType",value:"none"},{type:"gfxSetShape",shape:"explosion"},V(40),{type:"despawn"}]},J={name:"roundExplosion",diameter:40,hp:9999,actions:[{type:"setAttribute",attribute:"collisionType",value:"none"},{type:"gfxSetShape",shape:"roundExplosion"},V(75),{type:"despawn"}]},Q=({moveDeltaX:e,moveDeltaY:t})=>({type:"spawn",enemy:"playerShot",actions:[B($({type:"moveDelta",x:e,y:t},{type:"waitNextFrame"}))]}),Z=[Q({moveDeltaX:0,moveDeltaY:-9}),Q({moveDeltaX:1.5,moveDeltaY:-9}),Q({moveDeltaX:-1.5,moveDeltaY:-9}),V(8)],ee=[{type:"spawn",enemy:"playerLaser",y:15},{type:"spawn",enemy:"playerLaser",y:10},{type:"spawn",enemy:"playerLaser",y:5},{type:"spawn",enemy:"playerLaser",y:0},{type:"spawn",enemy:"playerLaser",y:-5},{type:"spawn",enemy:"playerLaser",y:-10},V(3)],te={name:"player",diameter:20,hp:1,actions:[{type:"setAttribute",attribute:"points",value:0},{type:"gfxSetColor",color:"aqua"},{type:"setMoveDirection",degrees:0},{type:"setAttribute",attribute:"collisionType",value:"player"},{type:"setAttribute",attribute:"boundToWindow",value:!0},{type:"gfxSetShape",shape:"none"},V(1),{type:"gfxSetShape",shape:"diamondShield"},B($({type:"moveAccordingToInput"},{type:"waitNextFrame"})),B($({type:"waitInputShoot"},...Z)),B($({type:"waitInputLaser"},...ee))]},se={name:"playerLaser",hp:1,diameter:5,onDeathAction:z("explosion"),actions:[{type:"setAttribute",attribute:"collisionType",value:"playerBullet"},{type:"setAttribute",attribute:"pointsOnDeath",value:-.2},{type:"setAttribute",attribute:"points",value:0},{type:"gfxSetShape",shape:"square"},{type:"gfxSetColor",color:"aqua"},U($({type:"moveDelta",y:-30},{type:"waitNextFrame"}),[V(8),{type:"despawn"}])]},ie={name:"playerShot",hp:1,diameter:5,onDeathAction:z("explosion"),actions:[{type:"setAttribute",attribute:"collisionType",value:"playerBullet"},{type:"setAttribute",attribute:"pointsOnDeath",value:-1},{type:"setAttribute",attribute:"points",value:0},{type:"gfxSetShape",shape:"circle"},{type:"gfxSetColor",color:"aqua"}]},ne={name:"spawner",diameter:20,hp:9999,actions:[B(V(3200),{type:"finishLevel"}),{type:"setAttribute",attribute:"collisionType",value:"none"},{type:"gfxSetShape",shape:"none"},z("parallax"),z("player",{x:178.5,y:220}),z("stage1")]},ae=z("nonShootingAimer",{x:128.5,y:-22}),oe=z("nonShootingAimer",{x:228.5,y:-22}),re=z("sinus",{x:75,y:-20}),he=z("sinus",{x:280,y:-20,actions:[{type:"setAttribute",attribute:"right",value:!0}]}),le=z("firstMiniboss",{x:118.881,y:-20}),ce=z("firstMiniboss",{x:237.762,y:-20,actions:[{type:"setAttribute",attribute:"right",value:!0}]}),pe=R(8,[ae,oe,V(40)]),de=R(5,[re,V(70),he,V(70)]),me={name:"stage1",diameter:20,hp:9999,actions:[{type:"setAttribute",attribute:"collisionType",value:"none"},{type:"gfxSetShape",shape:"none"},V(120),pe,V(120),de,V(200),le,ce]},ue={name:"nonShootingAimer",hp:4,diameter:22,onDeathAction:z("roundExplosion"),actions:[X(1.6),j(R(26.25,[{type:"rotate_towards_player"},V(8)]),$({type:"move_according_to_speed_and_direction"},{type:"waitNextFrame"}))]},ye={type:"move",frames:80,x:-205,y:30},ge={...ye,x:205},ve={type:"rotate_around_relative_point",degrees:-180,frames:35,point:{y:31}},fe={...ve,degrees:180},xe=[V(16),{type:"shoot_toward_player"}],be=j(ve,xe),we=j(fe,xe),Se={name:"sinus",hp:3,diameter:24,onDeathAction:z("roundExplosion"),actions:[Y(2),H("right",{is:!0,yes:[{type:"mirrorX",value:!0}]}),q(be,ge,we,ye)]},Ie=[V(75),$(Y(2.6),((...e)=>R(3,e))({type:"shootDirection",x:0,y:1},V(3)),V(55),Y(2.2),q({type:"shoot_toward_player"},{type:"shoot_beside_player",degrees:25},{type:"shoot_beside_player",degrees:-25},V(64)))],Ee=N({x:116,y:0,frames:40}),ke=N({y:75,frames:52}),Ae=N({x:139.5,frames:47}),De=N({y:11,frames:100}),Te=N({x:99.5,frames:50}),Ce=N({y:141,frames:30}),Pe=N({y:61,frames:80}),Fe=N({x:138.5,y:105,frames:40}),_e=N({x:98.5,y:290,frames:210}),Me={name:"firstMiniboss",hp:120,diameter:35,actions:[U(Ie,[H("right",{is:!0,yes:[{type:"mirrorX",value:!0}]}),Ee,ke,{type:"rotate_around_relative_point",degrees:-90,frames:39,point:{x:25,y:-5}},V(25),{type:"rotate_around_relative_point",degrees:90,frames:39,point:{x:-20,y:-11}},V(25),Ae,V(25),De,V(25),{type:"rotate_around_absolute_point",point:{y:61},degrees:-180,frames:100},V(25),Te,V(25),Ce,V(25),Pe,V(25),Fe,V(25),H("right",{is:!0,yes:[{type:"mirrorY",value:!0}]}),{type:"rotate_around_absolute_point",point:{x:178.5},degrees:360,frames:240},V(25),{type:"rotate_around_absolute_point",point:{x:178.5},degrees:-360,frames:240},H("right",{is:!0,yes:[{type:"mirrorY",value:!1}]}),V(25),_e])]},Oe=179,Ge={"-1":-24,0:0,1:24,2:48,3:72,4:96,5:120,6:144,7:168,8:192,9:216,10:240,11:264},We={name:"stage2",diameter:20,hp:9999,actions:[{type:"spawn",enemy:"cloner",x:Oe,y:-20},V(270),{type:"spawn",enemy:"cloner",x:71,y:-20},{type:"spawn",enemy:"cloner",x:286,y:-20}]},Le={name:"cloner",hp:25,diameter:29,actions:[N({y:45,frames:150}),V(30),{type:"spawn",enemy:"clonerChild"},{type:"spawn",enemy:"clonerChild",actions:[{type:"setAttribute",attribute:"mirrorX",value:!0}]},V(80),{type:"spawn",enemy:"clonerChild",actions:[{type:"setAttribute",attribute:"mirrorY",value:!0}]},{type:"spawn",enemy:"clonerChild",actions:[{type:"setAttribute",attribute:"mirrorX",value:!0},{type:"setAttribute",attribute:"mirrorY",value:!0}]}]},He={name:"clonerChild",hp:10,diameter:18,actions:[H("mirrorX",{is:!0,yes:[{type:"mirrorX",value:!0}]}),H("mirrorY",{is:!0,yes:[{type:"mirrorY",value:!0}]}),Y(1.5),j({type:"move",x:-45,y:-20,frames:65},[V(60),$({type:"shootDirection",x:0,y:1},V(40))])]},$e={name:"stage3",diameter:20,hp:9999,actions:[{type:"gfxSetShape",shape:"none"},{type:"spawn",enemy:"shapeShifter",x:Oe,y:Ge[5]},{type:"spawn",enemy:"healer",x:143,y:Ge[4]},{type:"spawn",enemy:"dehealer",x:214,y:Ge[4]}]},Be={name:"shapeShifter",diameter:30,hp:100,onDeathAction:{type:"spawn",enemy:"shapeShifter",y:-20},actions:[$({type:"gfxSetShape",shape:"circle"},V(60),{type:"gfxSetShape",shape:"square"},V(60),{type:"gfxSetShape",shape:"triangle"},V(60),{type:"gfxSetShape",shape:"diamondShield"},V(60),{type:"gfxSetShape",shape:"octagon"},V(60))]},Ne={name:"healer",diameter:30,hp:50,actions:[{type:"setAttribute",attribute:"hp",value:25},$(V(10),H("hp",{is:50,no:[{type:"incr",attribute:"hp"}]}))]},je={name:"dehealer",diameter:30,hp:50,actions:[$(V(10),{type:"decr",attribute:"hp"})]},Ue=({x:e=36,y:t=-30})=>({type:"spawn",enemy:"easyFlyer",x:e,y:t}),Re={name:"stage4",diameter:20,hp:9999,actions:[{type:"spawn",enemy:"easyFlyer",x:-100,y:0,actions:[{type:"setMoveDirection",degrees:140}]},{type:"spawn",enemy:"easyFlyer",x:-50,y:-50,actions:[{type:"setMoveDirection",degrees:135}]},{type:"spawn",enemy:"easyFlyer",x:0,y:-100,actions:[{type:"setMoveDirection",degrees:135}]},{type:"wait",frames:30},{type:"spawn",enemy:"easyFlyer",x:321,y:Ge[-1],actions:[{type:"setMoveDirection",degrees:-135}]},{type:"spawn",enemy:"easyFlyer",x:357,y:Ge[0],actions:[{type:"setMoveDirection",degrees:-135}]},{type:"spawn",enemy:"easyFlyer",x:393,y:Ge[1],actions:[{type:"setMoveDirection",degrees:-135}]},{type:"wait",frames:60},{type:"wait",frames:240},{type:"repeat",times:5,actions:[Ue({x:36,y:-20}),Ue({x:107,y:-20}),Ue({x:Oe,y:-20}),Ue({x:250,y:-20}),Ue({x:321,y:-20}),{type:"wait",frames:80},Ue({x:0,y:-20}),Ue({x:71,y:-20}),Ue({x:143,y:-20}),Ue({x:214,y:-20}),Ue({x:286,y:-20}),Ue({x:357,y:-20}),{type:"wait",frames:80}]}]},Xe={name:"easyFlyer",diameter:29,hp:5,actions:[{type:"setSpeed",pixelsPerFrame:1.17},{type:"gfxSetColor",color:"green"},$({type:"move_according_to_speed_and_direction"},{type:"waitNextFrame"})]},ze={startScreenImageUrl:"/schmupinator/assets/startScreen-bf582d98.png",gameObjects:[te,se,ie,{name:"parallax",diameter:240,hp:9999,actions:[{type:"setAttribute",attribute:"collisionType",value:"none"},{type:"gfxSetColor",color:"black"},{type:"gfxSetShape",shape:"square"},{type:"gfxFillScreen"},z("layer1"),z("layer2"),z("layer3")]},{name:"layer1",diameter:240,hp:9999,actions:[{type:"setAttribute",attribute:"collisionType",value:"none"},{type:"gfxSetShape",shape:"layer1.png"},{type:"gfxFillScreen"},$(V(1),{type:"gfxScrollBg",y:-.3})]},{name:"layer2",diameter:240,hp:9999,actions:[{type:"setAttribute",attribute:"collisionType",value:"none"},{type:"gfxSetShape",shape:"layer2.png"},{type:"gfxFillScreen"},$(V(1),{type:"gfxScrollBg",y:-1})]},{name:"layer3",diameter:240,hp:9999,actions:[{type:"setAttribute",attribute:"collisionType",value:"none"},{type:"gfxSetShape",shape:"layer3.png"},{type:"gfxFillScreen"},$(V(1),{type:"gfxScrollBg",y:-1.5})]},K,J,{name:"shot",hp:9999,diameter:5,actions:[{type:"setAttribute",attribute:"collisionType",value:"enemyBullet"},{type:"setAttribute",attribute:"points",value:0},{type:"gfxSetShape",shape:"circle"}]},ne,me,ue,Se,Me,We,Le,He,$e,Be,Ne,je,Re,Xe,{name:"stage5",diameter:20,hp:9999,actions:[{type:"gfxSetShape",shape:"none"},z("aqua",{x:107,y:Ge[3]}),z("executor",{x:Oe,y:Ge[5]})]},{name:"executor",diameter:30,hp:1e5,actions:[{type:"gfxSetColor",color:"green"},$({type:"setAttribute",gameObjectId:"global",attribute:"aquaShoot",value:!0},V(1),{type:"setAttribute",gameObjectId:"global",attribute:"aquaShoot",value:!1},V(35))]},{name:"aqua",diameter:30,hp:1e5,actions:[{type:"gfxSetColor",color:"aqua"},{type:"setShotSpeed",pixelsPerFrame:2},$({type:"waitUntilAttrIs",gameObjectId:"global",attr:"aquaShoot",is:!0},{type:"shootDirection",x:0,y:1},V(1))]}]},Ye={name:"explosion",diameter:18,hp:9999,actions:[{type:"setAttribute",attribute:"collisionType",value:"none"},{type:"gfxSetShape",shape:"explosion"},V(40),{type:"despawn"}]},qe={name:"roundExplosion",diameter:40,hp:9999,actions:[{type:"setAttribute",attribute:"collisionType",value:"none"},{type:"gfxSetShape",shape:"roundExplosion"},V(75),{type:"despawn"}]},Ve=[(({moveDeltaX:e,moveDeltaY:t})=>({type:"spawn",enemy:"playerShot",actions:[B($({type:"moveDelta",x:e,y:t},{type:"waitNextFrame"}))]}))({moveDeltaY:0,moveDeltaX:9}),V(8)],Ke={name:"player",diameter:20,hp:1,actions:[{type:"setAttribute",attribute:"points",value:0},{type:"gfxSetColor",color:"aqua"},{type:"setMoveDirection",degrees:0},{type:"setAttribute",attribute:"collisionType",value:"player"},{type:"setAttribute",attribute:"boundToWindow",value:!0},{type:"gfxSetShape",shape:"none"},{type:"setMoveDirection",degrees:90},V(1),{type:"gfxSetShape",shape:"stage2/player.png"},B($({type:"moveAccordingToInput"},{type:"waitNextFrame"})),B($({type:"waitInputShoot"},...Ve))]},Je={name:"playerShot",hp:1,diameter:5,onDeathAction:z("explosion"),actions:[{type:"setAttribute",attribute:"collisionType",value:"playerBullet"},{type:"setAttribute",attribute:"pointsOnDeath",value:-1},{type:"setAttribute",attribute:"points",value:0},{type:"gfxSetShape",shape:"circle"},{type:"gfxSetColor",color:"aqua"}]},Qe=429,Ze=120,et={name:"spawner",diameter:20,hp:9999,actions:[B(V(18e3),{type:"finishLevel"}),{type:"setAttribute",attribute:"collisionType",value:"none"},{type:"gfxSetShape",shape:"none"},z("parallax"),z("player",{x:36,y:Ze}),z("stage")]},tt=z("nonShootingAimer",{x:393,y:72}),st=z("nonShootingAimer",{x:393,y:168}),it=R(8,[tt,st,V(40)]),nt={name:"stage",diameter:20,hp:9999,actions:[{type:"setAttribute",attribute:"collisionType",value:"none"},{type:"gfxSetShape",shape:"none"},V(60),it,V(60),z("spinningDots",{x:Qe,y:Ze}),V(480),z("spinningDots",{x:Qe,y:72}),V(90),z("spinningDots",{x:Qe,y:168}),V(480),z("spinningDots",{x:Qe,y:24}),V(90),z("spinningDots",{x:Qe,y:Ze}),V(90),z("spinningDots",{x:Qe,y:216}),V(360),z("boss",{x:Qe,y:Ze})]},at={name:"parallax",diameter:240,hp:9999,actions:[{type:"setAttribute",attribute:"collisionType",value:"none"},{type:"gfxSetColor",color:"black"},{type:"gfxSetShape",shape:"square"},{type:"gfxFillScreen"},z("layer1"),z("layer2"),z("layer3")]},ot={name:"layer1",diameter:240,hp:9999,actions:[{type:"setAttribute",attribute:"collisionType",value:"none"},{type:"gfxSetShape",shape:"layer1.png"},{type:"gfxFillScreen"},$(V(1),{type:"gfxScrollBg",x:.3})]},rt={name:"layer2",diameter:240,hp:9999,actions:[{type:"setAttribute",attribute:"collisionType",value:"none"},{type:"gfxSetShape",shape:"layer2.png"},{type:"gfxFillScreen"},$(V(1),{type:"gfxScrollBg",x:1})]},ht={name:"layer3",diameter:240,hp:9999,actions:[{type:"setAttribute",attribute:"collisionType",value:"none"},{type:"gfxSetShape",shape:"layer3.png"},{type:"gfxFillScreen"},$(V(1),{type:"gfxScrollBg",x:1.5})]},lt={name:"nonShootingAimer",hp:1,diameter:22,onDeathAction:z("roundExplosion"),actions:[X(1.6),j(R(26.25,[{type:"rotate_towards_player"},V(8)]),$({type:"move_according_to_speed_and_direction"},{type:"waitNextFrame"}))]},ct={name:"dot",hp:20,diameter:20,onDeathAction:z("roundExplosion"),actions:[{type:"gfxSetShape",shape:"stage2/circle.png"}]},pt={name:"traceDot",hp:9999,diameter:5,actions:[V(180),{type:"despawn"}]},dt=({x:e,y:t})=>({type:"rotate_around_relative_point",degrees:-5400,frames:12e3,point:{x:e,y:t}}),mt={name:"spinningDots",hp:9999,diameter:5,onDeathAction:z("roundExplosion"),actions:[{type:"setAttribute",attribute:"collisionType",value:"none"},{type:"gfxSetShape",shape:"none"},{type:"gfxSetShape",shape:"stage2/circle.png"},{type:"gfxSetColor",color:"aqua"},z("dot",{actions:[B($({type:"moveDelta",x:-.55},{type:"waitNextFrame"}))]}),z("dot",{x:27,actions:[B($({type:"moveDelta",x:-.55},{type:"waitNextFrame"})),B(dt({x:-27}))]}),z("dot",{x:54,actions:[B($({type:"moveDelta",x:-.55},{type:"waitNextFrame"})),B(dt({x:-54}))]}),z("dot",{x:-27,actions:[B($({type:"moveDelta",x:-.55},{type:"waitNextFrame"})),B(dt({x:27}))]}),z("dot",{x:-54,actions:[B($({type:"moveDelta",x:-.55},{type:"waitNextFrame"})),B(dt({x:54}))]}),{type:"despawn"}]},ut=e=>[{type:"gfxSetColor",color:"aqua"},{type:"wait",frames:10},{type:"gfxSetColor",color:"red"},{type:"wait",frames:10},{type:"setShotSpeed",pixelsPerFrame:e},{type:"shootDirection",x:1,y:-1},{type:"shootDirection",x:1,y:0},{type:"shootDirection",x:1,y:1},{type:"shootDirection",x:0,y:1},{type:"shootDirection",x:-1,y:1},{type:"shootDirection",x:-1,y:0},{type:"shootDirection",x:-1,y:-1},{type:"shootDirection",x:0,y:-1}],yt=[j([R(4,[{type:"setShotSpeed",pixelsPerFrame:.9},{type:"shoot_toward_player"},{type:"wait",frames:70}]),R(10,[{type:"setShotSpeed",pixelsPerFrame:1},{type:"shoot_toward_player"},{type:"wait",frames:28}]),R(16,[{type:"setShotSpeed",pixelsPerFrame:1.1},{type:"shoot_toward_player"},{type:"wait",frames:8}]),$({type:"setShotSpeed",pixelsPerFrame:1.1},{type:"shoot_toward_player"},{type:"wait",frames:8})],[V(420),R(5,[...ut(.8),{type:"wait",frames:300}]),$(...ut(.8),{type:"wait",frames:150})])],gt=[{type:"moveToAbsolute",frames:450,moveTo:{x:179}}],vt=(e,t)=>[z("roundExplosion",{x:-e,y:0}),V(t),V(t),z("roundExplosion",{x:e,y:0}),V(t),z("roundExplosion",{x:0,y:-e}),V(t),z("roundExplosion",{x:0,y:e}),z("roundExplosion",{x:-e,y:-e}),z("roundExplosion",{x:e,y:e}),V(t),z("roundExplosion",{x:-e,y:e}),z("roundExplosion",{x:e,y:-e})],ft={startScreenImageUrl:"/schmupinator/assets/startScreen-6e48ed66.png",gameObjects:[Ke,Je,at,ot,rt,ht,Ye,qe,{name:"shot",hp:9999,diameter:5,actions:[{type:"setAttribute",attribute:"collisionType",value:"enemyBullet"},{type:"setAttribute",attribute:"points",value:0},{type:"gfxSetShape",shape:"circle"}]},et,nt,ct,pt,mt,lt,{name:"boss",hp:1e5,diameter:40,onDeathAction:z("bossCorpse"),actions:[{type:"gfxSetShape",shape:"stage2/circle.png"},...gt,{type:"setAttribute",attribute:"hp",value:70},j(yt)]},{name:"bossCorpse",diameter:18,hp:9999,actions:[{type:"setAttribute",attribute:"collisionType",value:"none"},{type:"gfxSetShape",shape:"explosion"},j(vt(8,3),vt(24,5),vt(16,15)),{type:"wait",frames:180},{type:"finishLevel"}]}]};class xt{constructor({name:e}){t(this,"name"),t(this,"games"),t(this,"activeGame"),t(this,"Init",(()=>{const e=ze.gameObjects.reduce(((e,t)=>(e[t.name]=t,e)),{});this.games.game1={gameObjects:e,startScreenImageUrl:ze.startScreenImageUrl};const t=ft.gameObjects.reduce(((e,t)=>(e[t.name]=t,e)),{});return this.games.game2={gameObjects:t,startScreenImageUrl:ft.startScreenImageUrl},Promise.resolve()})),t(this,"setActiveGame",(e=>{this.activeGame=e})),t(this,"getActiveGame",(()=>this.activeGame)),t(this,"getAndAssertActiveGame",(()=>{if(void 0===this.activeGame)throw new Error("GameData.getAndAssertActiveGame: activeGame is undefined.");return this.activeGame})),t(this,"getGames",(()=>Object.keys(this.games))),t(this,"GetEnemy",(e=>{var t,s;if(!this.activeGame)throw new Error("GameData.GetEnemy: Error activeGame is not set.");const i=null==(s=null==(t=this.games[this.activeGame])?void 0:t.gameObjects)?void 0:s[e];if(!i)throw new Error(`GameData.GetEnemy: Unknown enemy "${e}".`);return i})),t(this,"getStartScreenImageUrl",(()=>{var e;if(!this.activeGame)throw new Error("GameData.GetStartScreenImageUrl: Error activeGame is not set.");const t=null==(e=this.games[this.activeGame])?void 0:e.startScreenImageUrl;if(!t)throw new Error("GameData.GetStartScreenImageUrl: No startScreenImageUrl.");return t})),this.name=e,this.games={},this.activeGame="game1"}}const bt="/schmupinator/images/circle.png";class wt{constructor(e,s){t(this,"vars",{x:100,y:100,scale:1,rotation:0,shape:"circle",color:"red",diameter:5}),t(this,"element"),t(this,"logError",((...e)=>{console.error("GraphicsElement:",...e)})),t(this,"logWarn",((...e)=>{})),t(this,"destroy",(()=>{void 0!==this.element&&(this.element.remove(),this.element=void 0)})),t(this,"reset",((e,t)=>{void 0!==this.element?this.resetElement(e,t,this.element):this.logError("Tried to reset an undefined element")})),t(this,"resetElement",((e,t,s)=>{this.vars={color:"red",diameter:5,rotation:0,scale:1,shape:"circle",x:e,y:t};const i=this.vars.diameter/2,n=t-i,a=e-i;s.style.backgroundImage=`url('${bt}')`,s.style.filter="none",s.style.width=A(this.vars.diameter),s.style.height=A(this.vars.diameter),s.style.top=A(n),s.style.left=A(a),s.style.transform="rotate(0deg) scale(1)"})),t(this,"setX",(e=>{if(void 0===this.element)return void this.logError("Tried to setX of undefined element");if(this.vars.x===e)return void this.logWarn(`Tried to setX to ${e} when it was already ${e}`);const t=this.vars.diameter/2;this.vars.x=e,this.element.style.left=A(e-t)})),t(this,"setY",(e=>{if(void 0===this.element)return void this.logError("Tried to setY of undefined element");if(this.vars.y===e)return void this.logWarn(`Tried to setY to ${e} when it was already ${e}`);const t=this.vars.diameter/2;this.vars.y=e,this.element.style.top=A(e-t)})),t(this,"setDiameter",(e=>{if(void 0===this.element)return void this.logError("Tried to setDiameter of undefined element");if(this.vars.diameter===e)return void this.logWarn(`Tried to setDiameter to ${e} when it was already ${e}`);this.vars.diameter=e;const t=e/2,s=this.element.style;s.width=A(e),s.height=A(e),s.left=A(this.vars.x-t),s.top=A(this.vars.y-t)})),t(this,"setColor",(e=>{if(void 0!==this.element)if(this.vars.color!==e)switch(this.vars.color=e,e){case"red":this.element.style.filter="none";break;case"black":this.element.style.filter="brightness(0)";break;case"green":this.element.style.filter="hue-rotate(135deg) brightness(1.09)";break;case"aqua":this.element.style.filter="hue-rotate(180deg) brightness(3)";break;default:a.Alert(`Graphics.actionSetColor: unknown color '${e}'`)}else this.logWarn(`Tried to setColor to ${e} when it was already ${e}`);else this.logError("Tried to setColor of undefined element")})),t(this,"setShape",(e=>{if(void 0!==this.element)if(this.vars.shape!==e)switch(this.vars.shape=e,e){case"none":this.element.style.backgroundImage="none";break;case"circle":this.element.style.backgroundImage=`url('${bt}')`;break;case"square":this.element.style.backgroundImage="url('/schmupinator/images/square.png')";break;case"triangle":this.element.style.backgroundImage="url('/schmupinator/images/triangle.png')";break;case"diamondShield":this.element.style.backgroundImage="url('/schmupinator/images/diamondShield.png')";break;case"octagon":this.element.style.backgroundImage="url('/schmupinator/images/octagon.png')";break;case"explosion":{const e=`?id=${Date.now()}`;this.element.style.backgroundImage=`url('/schmupinator/images/explosion.png${e}')`;break}case"roundExplosion":{const e=`?id=${Date.now()}`;this.element.style.backgroundImage=`url('/schmupinator/images/roundExplosion.png${e}')`;break}default:this.element.style.backgroundImage=`url('/schmupinator/images/${e}')`}else this.logWarn(`Tried to setShape to ${e} when it was already ${e}`);else this.logError("Tried to setShape of undefined element")})),t(this,"setRotation",(e=>{void 0!==this.element?this.vars.rotation!==e?(this.vars.rotation=e,this.element.style.transform=`rotate(${this.vars.rotation}deg) scale(${this.vars.scale})`):this.logWarn(`Tried to setRotation to ${e} when it was already ${e}`):this.logError("Tried to setRotation of undefined element")})),t(this,"setScale",(e=>{void 0!==this.element?this.vars.scale!==e?(this.vars.scale=e,this.element.style.transform=`rotate(${this.vars.rotation}deg) scale(${this.vars.scale})`):this.logWarn(`Tried to setScale to ${e} when it was already ${e}`):this.logError("Tried to setScale of undefined element")})),t(this,"scrollBg",(({x:e,y:t})=>{if(void 0!==this.element){if(void 0!==e){const t=this.element.style.backgroundPositionX.replace("px","")??"",s=(parseFloat(t)||0)+e;this.element.style.backgroundRepeat="repeat",this.element.style.backgroundPositionX=A(s)}if(void 0!==t){const e=this.element.style.backgroundPositionY.replace("px","")??"",s=(parseFloat(e)||0)+t;this.element.style.backgroundRepeat="repeat",this.element.style.backgroundPositionY=A(s)}}else this.logError("Tried to scrollBg of undefined element")})),t(this,"fillScreen",(()=>{if(void 0===this.element)return void this.logError("Tried to fillScreen of undefined element");const e=this.element.style;e.width=A(l),e.height=A(c),e.backgroundSize="cover",e.left=A(0),e.top=A(0)})),this.element=a.WithWindow((t=>{const i=t.document.createElement("div");return this.applyUnchangingDefaults(i),this.resetElement(e,s,i),t.document.body.appendChild(i),i}))}applyUnchangingDefaults(e){e.style.position="fixed",e.style.boxSizing="border-box",e.style.backgroundSize="contain",e.style.imageRendering="pixelated",e.style.backgroundRepeat="no-repeat",e.style.backgroundPosition="center",e.style.zIndex="0"}}const St=class e{constructor({name:s}){t(this,"name"),t(this,"elementPool"),t(this,"destroy",(()=>{Object.values(this.elementPool).forEach((e=>{void 0!==e&&e.element.destroy()})),this.elementPool={}})),t(this,"Init",(async()=>{})),t(this,"Dispatch",(e=>{switch(e.type){case"gfxAskForElement":return this.actionAskForElement();case"gfxSetPosition":return this.actionSetPosition(e);case"gfxSetDiameter":return this.actionSetDiameter(e);case"gfxRelease":return this.actionRelease(e);case"gfxSetColor":return this.actionSetColor(e);case"gfxSetShape":return this.actionSetShape(e);case"gfxSetRotation":return this.actionSetRotation(e);case"gfxSetScale":return this.actionSetScale(e);case"gfxScrollBg":return this.actionScrollBg(e);case"gfxFillScreen":return this.actionFillScreen(e);default:{const t=`unknown action type: ${e.type}`;throw a.Alert(t),new Error(t)}}})),t(this,"getRestingPlace",(e=>({x:377+10*Math.floor(e/10),y:20+e%10*10}))),t(this,"initElementPool",(()=>{const t=Array(e.poolSize).fill(0),s={};return t.forEach(((e,t)=>{const i=this.initOneElement(t);s[i.handle]=i})),s})),t(this,"initOneElement",(e=>{const{x:t,y:s}=this.getRestingPlace(e);return{handle:`${x("guid")}`,inUse:!1,element:new wt(t,s),index:e}})),t(this,"findExistingAndInUse",(e=>{const t=this.elementPool[e];if(!t)throw a.Alert(`Graphics: No GraphicsElement with handle "${e}"!`),new Error(`Graphics: No GraphicsElement with handle "${e}"!`);if(!t.inUse)throw a.Alert(`Graphics: Trying to set position for unused handle "${e}"!`),new Error(`Graphics: Trying to set position for unused handle "${e}"!`);return t})),t(this,"actionAskForElement",(()=>{const e=Object.values(this.elementPool).find((e=>!e.inUse));if(e)return e.inUse=!0,{type:"responseAskForElement",handle:e.handle};throw a.Alert("Graphics: All elements are in use!"),new Error("Graphics: All elements are in use!")})),t(this,"actionSetPosition",(({handle:e,x:t,y:s})=>{const i=this.findExistingAndInUse(e);return void 0!==t&&i.element.setX(t),void 0!==s&&i.element.setY(s),{type:"responseVoid"}})),t(this,"actionSetDiameter",(({handle:e,diameter:t})=>(this.findExistingAndInUse(e).element.setDiameter(t),{type:"responseVoid"}))),t(this,"actionRelease",(({handle:e})=>{const t=this.findExistingAndInUse(e),{x:s,y:i}=this.getRestingPlace(t.index);return t.element.reset(s,i),t.inUse=!1,{type:"responseVoid"}})),t(this,"actionSetColor",(({handle:e,color:t})=>(this.findExistingAndInUse(e).element.setColor(t),{type:"responseVoid"}))),t(this,"actionSetShape",(({handle:e,shape:t})=>(this.findExistingAndInUse(e).element.setShape(t),{type:"responseVoid"}))),t(this,"actionSetRotation",(({handle:e,degrees:t})=>(this.findExistingAndInUse(e).element.setRotation(t),{type:"responseVoid"}))),t(this,"actionSetScale",(({handle:e,scale:t})=>(this.findExistingAndInUse(e).element.setScale(t),{type:"responseVoid"}))),t(this,"actionScrollBg",(({handle:e,x:t,y:s})=>(this.findExistingAndInUse(e).element.scrollBg({x:t,y:s}),{type:"responseVoid"}))),t(this,"actionFillScreen",(({handle:e})=>(this.findExistingAndInUse(e).element.fillScreen(),{type:"responseVoid"}))),this.name=s,this.elementPool=this.initElementPool()}};t(St,"poolSize",100);let It=St;const Et=()=>a.WithWindow((e=>{const t=e.document.createElement("div");return t.style.position="fixed",t.style.backgroundImage="url('/schmupinator/images/menuBackground.png')",t.style.filter="brightness(70%)",t.style.backgroundSize="cover",t.style.top=A(0),t.style.left=A(0),t.style.width=A(l),t.style.height=A(c),t.style.zIndex=m,e.document.body.appendChild(t),t})),kt=e=>{const t=e.offsetWidth/2;return e.style.left=A(178.5-t),e},At=e=>{const{text:t,fontSize:s=16,left:i,top:n,right:o,className:r="",color:h="red",onClick:l=null,onMouseEnter:c=null,onMouseLeave:p=null}=e;return a.WithWindow((e=>{const a=e.document.createElement("div");return a.style.position="fixed",void 0!==n&&(a.style.top=A(n)),void 0!==i&&(a.style.left=A(i)),void 0!==o&&(a.style.right=A(o)),a.style.color=h,a.style.fontSize=A(s),a.style.whiteSpace="pre",a.style.zIndex=m,a.innerHTML=t,a.className=r,a.onclick=l,a.onmouseenter=c,a.onmouseleave=p,e.document.body.appendChild(a),a}))},Dt=class e{constructor(e){t(this,"top"),t(this,"menuItems"),t(this,"activeItemIndex"),t(this,"input"),t(this,"menuItemElements",[]),t(this,"setActiveIndex",(e=>{this.activeItemIndex!==e&&(void 0!==this.activeItemIndex&&this.unsetActiveItem(this.activeItemIndex),this.activeItemIndex=e,this.menuItemElements[e].classList.add("activeMenuItem"))})),t(this,"unsetActiveItem",(e=>{this.activeItemIndex===e&&(this.activeItemIndex=void 0,this.menuItemElements[e].classList.remove("activeMenuItem"))})),t(this,"incrActive",(()=>{void 0!==this.activeItemIndex&&this.activeItemIndex<this.menuItems.length-1&&this.setActiveIndex(this.activeItemIndex+1)})),t(this,"decrActive",(()=>{void 0!==this.activeItemIndex&&this.activeItemIndex>=1&&this.setActiveIndex(this.activeItemIndex-1)})),this.input=e.input,this.top=e.top,this.menuItems=e.menuItems.map(((e,t)=>({...e,index:t})))}render(){this.menuItemElements=this.menuItems.map(((t,s)=>{const i=At({text:t.text,fontSize:_.normal,top:this.top+s*e.spaceBetweenMenuItems,onClick:t.onClick,className:"menuItem",onMouseEnter:()=>{this.setActiveIndex(s)}});return kt(i),i})),this.setActiveIndex(0),this.input.onKeyUpCallback=e=>{switch(e){case"up":this.decrActive();break;case"down":this.incrActive();break;case"start":case"laser":case"shoot":void 0!==this.activeItemIndex&&this.menuItems[this.activeItemIndex].onClick()}}}destroy(){this.input.onKeyUpCallback=void 0,this.menuItemElements.forEach((e=>{e.remove()})),this.menuItemElements=[],this.activeItemIndex=void 0}};t(Dt,"spaceBetweenMenuItems",25);let Tt=Dt;class Ct{constructor(e){t(this,"ui"),t(this,"shadeElement"),t(this,"title"),t(this,"menu"),t(this,"version"),t(this,"onStartGame",(()=>{this.ui.SetActiveScene(this.ui.selectGame)})),this.ui=e.ui}render(){this.ui.settingsService.settings.skipStartMenu?this.onStartGame():(this.shadeElement=Et(),this.title=At({text:'<span class="flash3s"><span style="font-size: 76px;">S</span>chmupinator</span>',fontSize:60,top:36}),kt(this.title),this.menu=new Tt({input:this.ui.input,top:108,menuItems:[{text:"start game",onClick:this.onStartGame},{text:"highscore",onClick:()=>{this.ui.SetActiveScene(this.ui.selectGameForHighscore)}},{text:"settings",onClick:()=>{this.ui.SetActiveScene(this.ui.settings)}}]}),this.menu.render(),this.version=At({text:"0.6.0",fontSize:_.smallest,top:225,left:333,color:"rgba(255, 0, 0, 0.4)"}))}destroy(){var e,t,s,i;null==(e=this.shadeElement)||e.remove(),this.shadeElement=void 0,null==(t=this.title)||t.remove(),this.title=void 0,null==(s=this.menu)||s.destroy(),null==(i=this.version)||i.remove(),this.version=void 0}}class Pt{constructor(e){t(this,"ui"),t(this,"scoreElement"),t(this,"hiscoreElement"),t(this,"onEvent",(e=>{"uiScoreUpdated"===e.type&&this.scoreElement&&(this.scoreElement.innerHTML=`Score ${Math.round(e.points)}`)})),this.ui=e.ui}render(){this.scoreElement=At({text:"Score 0",color:"white",fontSize:_.smallest,top:10,left:20});const e=this.ui.highscoreService.getTop1().score;this.hiscoreElement=At({text:`Record ${e}`,color:"white",fontSize:_.smallest,top:10,left:285}),this.ui.eventsUi.subscribeToEvent("GameUI",this.onEvent)}destroy(){var e,t;null==(e=this.scoreElement)||e.remove(),this.scoreElement=void 0,null==(t=this.hiscoreElement)||t.remove(),this.hiscoreElement=void 0,this.ui.events.unsubscribeToEvent("GameUI")}}class Ft{constructor(e){t(this,"interval"),t(this,"originalSecondsLeft"),t(this,"currentSecondsLeft"),t(this,"onDone"),t(this,"input"),t(this,"element"),t(this,"destroy",(()=>{this.input.onKeyUpCallback=void 0,a.WithWindow((e=>{e.clearInterval(this.interval)})),this.element.remove()})),t(this,"tick",(()=>{this.currentSecondsLeft--,this.element.innerHTML=`${this.currentSecondsLeft}`,this.currentSecondsLeft<1&&(this.destroy(),this.onDone())}));const{input:s,secondsLeft:i,onDone:n,fontSize:o=_.smallest,left:r=0,top:h=0,className:l=""}=e;this.input=s,this.originalSecondsLeft=i,this.currentSecondsLeft=i,this.onDone=n,this.element=a.WithWindow((e=>{const t=e.document.createElement("div");return t.style.position="fixed",t.style.top=A(h),t.style.left=A(r),t.style.color="red",t.style.fontSize=A(o),t.style.whiteSpace="pre",t.style.zIndex=m,t.innerHTML=`${i}`,t.className=l,e.document.body.appendChild(t),t})),this.interval=a.SetInterval(this.tick,1e3),this.input.onKeyUpCallback=e=>{switch(e){case"laser":case"shoot":case"start":this.originalSecondsLeft-this.currentSecondsLeft>=1&&(this.destroy(),this.onDone())}}}}class _t{constructor(e){t(this,"ui"),t(this,"shadeElement"),t(this,"textElement"),t(this,"countdown"),t(this,"handleCountdDownDone",(()=>{const e=this.ui.points.points,{qualifiedForTop10:t,rank:s}=this.ui.highscoreService.qualifiedForTop10(e);t?this.ui.SetActiveScene(this.ui.enterHighscore,s):a.WithWindow((e=>{e.location.reload()}))})),this.ui=e.ui}render(){this.shadeElement=Et(),this.textElement=At({text:"Game Over",fontSize:_.largest,top:95}),kt(this.textElement),this.countdown=new Ft({input:this.ui.input,secondsLeft:5,onDone:this.handleCountdDownDone,fontSize:_.largest,top:130}),kt(this.countdown.element)}destroy(){var e,t,s;null==(e=this.shadeElement)||e.remove(),this.shadeElement=void 0,null==(t=this.textElement)||t.remove(),this.textElement=void 0,null==(s=this.countdown)||s.destroy(),this.countdown=void 0}}const Mt=(e,t)=>{const s=t-e.length;return`${e}${Array(s).fill(" ").join("")}`};class Ot{constructor(e){t(this,"ui"),t(this,"rank"),t(this,"backButton",!1),t(this,"shadeElement"),t(this,"title"),t(this,"top10"),t(this,"menu"),t(this,"getTop10Text",(()=>{const e=e=>Mt(e,10),t=e=>Mt(e,11);return[e("rank")+t("Score")+"Player",...this.ui.highscoreService.getTop10().map((({name:s,score:i},n)=>{const a=e(`${n+1}`),o=t(`${i}`);return w(this.rank)&&this.rank===n?`<span class="flash1s">${a}${o}${s}</span>`:`${a}${o}${s}`}))].join("\n")})),t(this,"handleExit",(()=>{this.backButton?this.ui.SetActiveScene(this.ui.startGame):a.WithWindow((e=>{e.location.reload()}))})),this.ui=e.ui}render(e){b(e)&&(w(null==e?void 0:e.rank)&&(this.rank=e.rank),"boolean"==typeof(null==e?void 0:e.backButton)&&(this.backButton=null==e?void 0:e.backButton)),this.shadeElement=Et(),this.title=At({text:"Highscore",fontSize:_.large,top:5}),kt(this.title),this.top10=At({text:this.getTop10Text(),fontSize:_.smaller,top:38}),kt(this.top10),this.menu=new Tt({input:this.ui.input,top:207,menuItems:[{text:this.backButton?"back":"continue",onClick:this.handleExit}]}),this.menu.render()}destroy(){var e,t,s,i;this.rank=void 0,this.backButton=!1,null==(e=this.shadeElement)||e.remove(),this.shadeElement=void 0,null==(t=this.title)||t.remove(),this.title=void 0,null==(s=this.top10)||s.remove(),this.top10=void 0,null==(i=this.menu)||i.destroy()}}const Gt=["_","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"];class Wt{constructor(e){t(this,"top"),t(this,"caretIndex",0),t(this,"charIndices",[0,0,0,0,0,0]),t(this,"onDone"),t(this,"input"),t(this,"charElements",[]),t(this,"getEnteredString",(()=>this.charIndices.map((e=>Gt[e])).join("").replaceAll("_"," "))),t(this,"updateCurrChar",(()=>{const e=this.charIndices[this.caretIndex];this.charElements[this.caretIndex].innerHTML=Gt[e]})),t(this,"incrCurrCharIndex",(()=>{this.charIndices[this.caretIndex]++,this.charIndices[this.caretIndex]>Gt.length-1&&(this.charIndices[this.caretIndex]=0),this.updateCurrChar()})),t(this,"decrCurrCharIndex",(()=>{this.charIndices[this.caretIndex]--,this.charIndices[this.caretIndex]<0&&(this.charIndices[this.caretIndex]=Gt.length-1),this.updateCurrChar()})),t(this,"setCaretIndex",((e,t=!1)=>{(t||this.caretIndex!==e)&&(this.charElements[this.caretIndex].classList.remove("activeMenuItem"),this.caretIndex=e,this.charElements[e].classList.add("activeMenuItem"))})),t(this,"incrCaretIndex",(()=>{void 0!==this.caretIndex&&this.caretIndex<this.charIndices.length-1&&this.setCaretIndex(this.caretIndex+1)})),t(this,"decrCaretIndex",(()=>{void 0!==this.caretIndex&&this.caretIndex>=1&&this.setCaretIndex(this.caretIndex-1)})),this.input=e.input,this.top=e.top,this.onDone=e.onDone}render(){const e=this.charIndices.map((e=>Gt[e])).map((e=>({text:e}))).map(((e,t)=>({...e,index:t})));this.charElements=e.map(((e,t)=>{const s=_.large;return At({text:e.text,fontSize:s,top:this.top,left:136+t*s*.37,className:"menuItem",onMouseEnter:()=>{this.setCaretIndex(t)}})})),this.setCaretIndex(0,!0),this.input.onKeyUpCallback=e=>{switch(e){case"up":this.incrCurrCharIndex();break;case"down":this.decrCurrCharIndex();break;case"left":this.decrCaretIndex();break;case"right":this.incrCaretIndex();break;case"start":this.onDone(this.getEnteredString())}}}destroy(){this.input.onKeyUpCallback=void 0,this.charElements.forEach((e=>{e.remove()})),this.charElements=[],this.caretIndex=0}}class Lt{constructor(e){t(this,"ui"),t(this,"rank"),t(this,"shadeElement"),t(this,"title"),t(this,"subTitle"),t(this,"flipCharacters"),t(this,"onEnteredName",(e=>{this.ui.highscoreService.registerNewEntry({name:e,score:this.ui.points.points}),this.ui.SetActiveScene(this.ui.highscore,{rank:this.rank})})),this.ui=e.ui}render(e){w(e)&&(this.rank=e),this.shadeElement=Et(),this.title=At({text:"Made it into the Highscore",fontSize:_.normal,top:20,className:"flash1s"}),kt(this.title),this.subTitle=At({text:"Enter thy name and\n become a legend",fontSize:_.small,top:70,className:"flash1s"}),kt(this.subTitle),this.flipCharacters=new Wt({input:this.ui.input,top:130,onDone:this.onEnteredName}),this.flipCharacters.render()}destroy(){var e,t,s,i;null==(e=this.shadeElement)||e.remove(),this.shadeElement=void 0,null==(t=this.title)||t.remove(),this.title=void 0,null==(s=this.subTitle)||s.remove(),this.subTitle=void 0,null==(i=this.flipCharacters)||i.destroy()}}class Ht{constructor(e){t(this,"ui"),t(this,"bgImageElement"),t(this,"countdown"),t(this,"handleCountdDownDone",(()=>{this.ui.gameLoop.Start(),this.ui.SetActiveScene(this.ui.game)})),this.ui=e.ui}render(){var e;this.ui.settingsService.settings.skipStartMenu?this.handleCountdDownDone():(this.bgImageElement=(e=this.ui.gameData.getStartScreenImageUrl(),a.WithWindow((t=>{const s=t.document.createElement("div");return s.style.position="fixed",s.style.backgroundImage=`url('${e}')`,s.style.backgroundSize="cover",s.style.top=A(0),s.style.left=A(0),s.style.width=A(l),s.style.height=A(c),s.style.zIndex=m,t.document.body.appendChild(s),s}))),this.countdown=new Ft({input:this.ui.input,secondsLeft:6,onDone:this.handleCountdDownDone,fontSize:_.large,top:5,left:315}))}destroy(){var e,t;null==(e=this.bgImageElement)||e.remove(),this.bgImageElement=void 0,null==(t=this.countdown)||t.destroy(),this.countdown=void 0}}class $t{constructor(e){t(this,"ui"),t(this,"shadeElement"),t(this,"title"),t(this,"menu"),t(this,"onSelectGame",(e=>{this.ui.gameData.setActiveGame(e),this.ui.SetActiveScene(this.ui.displayControls)})),this.ui=e.ui}render(){if(this.ui.settingsService.settings.skipStartMenu)return void this.onSelectGame("game1");this.shadeElement=Et(),this.title=At({text:'<span class="flash3s"><span style="font-size: 76px;">S</span>elect game</span>',fontSize:60,top:36}),kt(this.title);const e=this.ui.gameData.getGames().map((e=>({text:e,onClick:()=>{this.onSelectGame(e)}})));this.menu=new Tt({input:this.ui.input,top:108,menuItems:[...e,{text:"back",onClick:()=>{this.ui.SetActiveScene(this.ui.startGame)}}]}),this.menu.render()}destroy(){var e,t,s;null==(e=this.shadeElement)||e.remove(),this.shadeElement=void 0,null==(t=this.title)||t.remove(),this.title=void 0,null==(s=this.menu)||s.destroy()}}class Bt{constructor(e){t(this,"ui"),t(this,"shadeElement"),t(this,"title"),t(this,"menu"),t(this,"onSelectGame",(e=>{this.ui.gameData.setActiveGame(e),this.ui.SetActiveScene(this.ui.highscore,{backButton:!0})})),this.ui=e.ui}render(){this.shadeElement=Et(),this.title=At({text:'<span class="flash3s"><span style="font-size: 76px;">S</span>elect game</span>',fontSize:60,top:36}),kt(this.title);const e=this.ui.gameData.getGames().map((e=>({text:e,onClick:()=>{this.onSelectGame(e)}})));this.menu=new Tt({input:this.ui.input,top:108,menuItems:[...e,{text:"back",onClick:()=>{this.ui.SetActiveScene(this.ui.startGame)}}]}),this.menu.render()}destroy(){var e,t,s;null==(e=this.shadeElement)||e.remove(),this.shadeElement=void 0,null==(t=this.title)||t.remove(),this.title=void 0,null==(s=this.menu)||s.destroy()}}class Nt{constructor({name:e}){t(this,"name"),t(this,"events"),t(this,"eventsUi"),t(this,"gameLoop"),t(this,"highscoreService"),t(this,"points"),t(this,"settingsService"),t(this,"input"),t(this,"gameData"),t(this,"startGame"),t(this,"selectGame"),t(this,"settings"),t(this,"game"),t(this,"gameOver"),t(this,"highscore"),t(this,"selectGameForHighscore"),t(this,"enterHighscore"),t(this,"displayControls"),t(this,"activeScene"),t(this,"Init",(async e=>{this.events=null==e?void 0:e.events,this.eventsUi=null==e?void 0:e.eventsUi,this.gameLoop=null==e?void 0:e.gameLoop,this.highscoreService=null==e?void 0:e.highscore,this.points=null==e?void 0:e.points,this.settingsService=null==e?void 0:e.settings,this.input=null==e?void 0:e.input,this.gameData=null==e?void 0:e.gameData,this.events.subscribeToEvent(this.name,this.onEvent),this.SetActiveScene(this.startGame)})),t(this,"SetActiveScene",((e,t)=>{e!==this.activeScene?(this.activeScene&&this.activeScene.destroy(),this.activeScene=e,this.activeScene.render(t)):console.warn("Trying to set a scene to active which is already active.")})),t(this,"onEvent",(e=>{"player_died"===e.type&&(this.gameLoop.pause(),this.SetActiveScene(this.gameOver))})),t(this,"destroy",(()=>{this.startGame.destroy(),this.settings.destroy(),this.game.destroy(),this.gameOver.destroy(),this.highscore.destroy(),this.enterHighscore.destroy(),this.displayControls.destroy(),this.events.unsubscribeToEvent(this.name),this.activeScene=void 0})),this.name=e,this.startGame=new Ct({ui:this}),this.selectGame=new $t({ui:this}),this.settings=new class{constructor(e){t(this,"ui"),t(this,"shadeElement"),t(this,"title"),t(this,"menu"),t(this,"toggleSetting",(e=>{this.ui.settingsService.toggleSetting(e),this.refresh()})),t(this,"refresh",(()=>{this.destroy(),this.render()})),this.ui=e.ui}render(){const{fullscreen:e,gameSpeedSlider:t,fpsStats:s,outsideHider:i,autoplay:n,invincibility:a}=this.ui.settingsService.settings;this.shadeElement=Et(),this.title=At({text:'<span class="flash3s"><span style="font-size: 76px;">S</span>ettings</span>',fontSize:60,top:0}),kt(this.title),this.menu=new Tt({input:this.ui.input,top:60,menuItems:[{text:"fullscreen - "+(e?"on":"off"),onClick:()=>{this.toggleSetting("fullscreen")}},{text:"fpsStats - "+(s?"on":"off"),onClick:()=>{this.toggleSetting("fpsStats")}},{text:"gameSpeedSlider - "+(t?"on":"off"),onClick:()=>{this.toggleSetting("gameSpeedSlider")}},{text:"outsideHider - "+(i?"on":"off"),onClick:()=>{this.toggleSetting("outsideHider")}},{text:"autoplay - "+(n?"on":"off"),onClick:()=>{this.toggleSetting("autoplay")}},{text:"invincibility - "+(a?"on":"off"),onClick:()=>{this.toggleSetting("invincibility")}},{text:"back",onClick:()=>{this.ui.SetActiveScene(this.ui.startGame)}}]}),this.menu.render()}destroy(){var e,t,s;null==(e=this.shadeElement)||e.remove(),this.shadeElement=void 0,null==(t=this.title)||t.remove(),this.title=void 0,null==(s=this.menu)||s.destroy()}}({ui:this}),this.game=new Pt({ui:this}),this.gameOver=new _t({ui:this}),this.highscore=new Ot({ui:this}),this.selectGameForHighscore=new Bt({ui:this}),this.enterHighscore=new Lt({ui:this}),this.displayControls=new Ht({ui:this})}}class jt{constructor({name:e}){t(this,"name"),t(this,"scale"),t(this,"gameAspectRatio",1.4875),t(this,"Init",(async()=>{})),t(this,"destroy",(()=>{a.WithWindow((e=>{e.removeEventListener("resize",this.setFullscreen),e.document.body.style.transform="none",e.document.body.style.width="100%",e.document.body.style.height="100%"}))})),t(this,"setFullscreen",(()=>{a.WithWindow((e=>{const t=e.document.body,s=e.document.documentElement.clientWidth,i=e.document.documentElement.clientHeight;if(s/i>this.gameAspectRatio){this.scale=i/c;let e=0;e=(s-l*this.scale)/2,t.style.transform=`translateX(${e}px) scale(${this.scale})`}else this.scale=s/l,t.style.transform=`scale(${this.scale})`;t.style.width=1/this.scale*100+"%",t.style.height=1/this.scale*100+"%"}))})),this.name=e,this.scale=1,this.setFullscreen(),a.WithWindow((e=>{e.addEventListener("resize",this.setFullscreen)}))}}class Ut{constructor({name:e}){t(this,"name"),t(this,"frameCount",0),t(this,"history",{}),t(this,"recordedHistory"),t(this,"startTime",0),t(this,"collisions"),t(this,"events"),t(this,"eventsCollisions"),t(this,"eventsPoints"),t(this,"Init",(async e=>{this.recordedHistory=(await i((()=>import("./e2ehistory-00af34b8.js")),[])).recordedHistory,this.collisions=null==e?void 0:e.collisions,this.events=null==e?void 0:e.events,this.eventsCollisions=null==e?void 0:e.eventsCollisions,this.eventsPoints=null==e?void 0:e.eventsPoints,this.events.subscribeToEvent(this.name,this.onEvent),this.eventsCollisions.subscribeToEvent(this.name,this.onEvent),this.eventsPoints.subscribeToEvent(this.name,this.onEvent)})),t(this,"onEvent",(e=>{var t;if("player_died"===e.type){console.log("E2eTest: Test succeeded.");const e=a.PerformanceNow()-this.startTime;console.log(`E2eTest: Took ${e} ms to run test.`),console.log(`E2eTest: Collision detection took ${this.collisions.accumulatedTime} ms.`),n()||process.exit(0)}if("frame_tick"!==e.type){const s=this.frameCount;void 0===this.history[s]&&(this.history[s]=[]),null==(t=this.history[s])||t.push(e)}if("frame_tick"===e.type){0===this.startTime&&(this.startTime=a.PerformanceNow()),this.frameCount=e.frameNr;const t=e.frameNr-1,s=JSON.stringify(this.recordedHistory[t]),i=JSON.stringify(this.history[t]);s!==i&&a.Alert(`Test failed!\nFrame: ${t}\nExpected: ${s}\nActual: ${i}`)}})),this.name=e}}const Rt="__settings";class Xt{constructor({app:e,name:s}){t(this,"name"),t(this,"settings",{fullscreen:!0,gameSpeedSlider:!1,fpsStats:!1,outsideHider:!0,autoplay:!1,skipStartMenu:!1,invincibility:!1}),t(this,"app"),t(this,"Init",(async e=>{})),t(this,"toggleSetting",(e=>{const t=this.settings[e];this.settings[e]=!t,a.WithWindow((e=>{e.localStorage.setItem(Rt,JSON.stringify(this.settings))})),a.WithWindow((t=>{switch(e){case"fpsStats":this.app.fps.destroy(),this.app.fps=this.app.construct.fps(),this.app.init.fps();break;case"fullscreen":this.app.fullscreen.destroy(),this.app.fullscreen=this.app.construct.fullscreen(),this.app.init.fullscreen();break;case"gameSpeedSlider":this.app.gameSpeed.destroy(),this.app.gameSpeed=this.app.construct.gameSpeed(),this.app.init.gameSpeed();break;case"outsideHider":this.app.outsideHider.destroy(),this.app.outsideHider=this.app.construct.outsideHider(),this.app.init.outsideHider();break;case"skipStartMenu":break;default:t.location.reload()}}))})),this.app=e,this.name=s,a.WithWindow((e=>{const t=e.localStorage.getItem(Rt);t?this.settings=JSON.parse(t):e.localStorage.setItem(Rt,JSON.stringify(this.settings))}))}}class zt{constructor({name:e}){t(this,"name"),t(this,"gameHideBottom"),t(this,"gameHideRight"),t(this,"Init",(async e=>{})),t(this,"destroy",(()=>{var e,t;null==(e=this.gameHideBottom)||e.remove(),this.gameHideBottom=void 0,null==(t=this.gameHideRight)||t.remove(),this.gameHideRight=void 0})),this.name=e,this.gameHideBottom=a.WithWindow((e=>{const t=e.document.createElement("div");return t.style.height=A(1e3),t.style.width=A(l),t.style.position="fixed",t.style.top=A(c),t.style.left=A(0),t.style.backgroundColor="white",t.style.zIndex="1",e.document.body.appendChild(t),t})),this.gameHideRight=a.WithWindow((e=>{const t=e.document.createElement("div");return t.style.height=A(1e3),t.style.width=A(1e3),t.style.position="fixed",t.style.top=A(0),t.style.left=A(l),t.style.backgroundColor="white",t.style.zIndex="1",e.document.body.appendChild(t),t}))}}class Yt{constructor({name:e}){t(this,"name"),t(this,"attributes"),t(this,"Init",(async()=>{})),t(this,"destroy",(()=>{})),t(this,"getAndAssertAttribute",(({gameObjectId:e,attribute:t})=>{var s;const i=null==(s=this.attributes.gameObjects[e])?void 0:s[t];if(void 0===i){const e=`Attribute:  Attribute "${t}" does not exist.`;console.error(e)}return i})),t(this,"setAttribute",(({gameObjectId:e,attribute:t,value:s})=>{const i=this.attributes.gameObjects[e];void 0===i?this.attributes.gameObjects[e]={[t]:s}:i[t]=s})),t(this,"getAttribute",(e=>this.getAndAssertAttribute(e))),t(this,"incr",(e=>{if("number"!=typeof this.getAndAssertAttribute(e)){const t=`Attribute.incr: Tried to increment ${e.attribute} which is of type ${typeof e.attribute}`;throw a.Alert(t),new Error(t)}this.attributes.gameObjects[e.gameObjectId][e.attribute]++})),t(this,"decr",(e=>{if("number"!=typeof this.getAndAssertAttribute(e)){const t=`Attribute.decr: Tried to decrement${e.attribute} which is of type ${typeof e.attribute}`;throw a.Alert(t),new Error(t)}this.attributes.gameObjects[e.gameObjectId][e.attribute]--})),this.name=e,this.attributes={gameObjects:{}}}}class qt{constructor(){t(this,"name","noop"),t(this,"Init",(async()=>{})),t(this,"destroy",(()=>{}))}}class Vt{constructor({name:e}){t(this,"name"),t(this,"frameCount",0),t(this,"replay"),t(this,"events"),t(this,"Init",(async e=>{this.replay=(await i((()=>import("./replay-c91aab62.js")),[])).replay,this.events=null==e?void 0:e.events,this.events.subscribeToEvent(this.name,(e=>{"frame_tick"===e.type&&(this.frameCount=e.frameNr)}))})),this.name=e}get ButtonsPressed(){const e=`${this.frameCount}`,t={start:!1,down:!1,left:!1,right:!1,shoot:!1,laser:!1,up:!1};return e in this.replay.inputs?{...t,...this.replay.inputs[e]}:t}}class Kt{constructor({name:e}){t(this,"name"),t(this,"scale",1),t(this,"Init",(async()=>{})),t(this,"destroy",(()=>{})),this.name=e}}class Jt{constructor({name:e}){t(this,"name"),t(this,"Init",(async()=>{})),t(this,"Dispatch",(e=>({type:"responseVoid"}))),t(this,"destroy",(()=>{})),this.name=e}}class Qt{constructor({app:e,name:s}){t(this,"name"),t(this,"FrameCount"),t(this,"frameSpeedMultiplier"),t(this,"app"),t(this,"Init",(async()=>{})),t(this,"Start",(()=>{a.SetInterval(this.oneGameLoop,0)})),t(this,"pause",(()=>{this.frameSpeedMultiplier=0})),t(this,"nextFrame",(()=>{this.FrameCount++,this.app.events.dispatchEvent({type:"frame_tick",frameNr:this.FrameCount})})),t(this,"advanceFrames",(()=>{0!==this.frameSpeedMultiplier&&this.nextFrame()})),t(this,"oneGameLoop",(()=>{0!==this.frameSpeedMultiplier&&this.advanceFrames()})),this.app=e,this.name=s,this.FrameCount=0,this.frameSpeedMultiplier=1}}class Zt{constructor({app:e,name:s}){t(this,"name"),t(this,"FrameCount"),t(this,"nextFrameMillis"),t(this,"frameSpeedMultiplier"),t(this,"app"),t(this,"Init",(async()=>{})),t(this,"Start",(()=>{this.nextFrameMillis=a.PerformanceNow()+p,a.RequestAnimationFrame(this.oneGameLoop)})),t(this,"pause",(()=>{this.frameSpeedMultiplier=0})),t(this,"nextFrame",(()=>{this.FrameCount++,this.app.events.dispatchEvent({type:"frame_tick",frameNr:this.FrameCount}),this.app.eventsEndOfFrame.dispatchEvent({type:"end_of_frame",frameNr:this.FrameCount})})),t(this,"advanceFrames",(()=>{for(let e=0;e<this.frameSpeedMultiplier;e++)this.nextFrame()})),t(this,"tooSlowFrames",0),t(this,"oneGameLoop",(e=>{if(a.RequestAnimationFrame(this.oneGameLoop),null===this.nextFrameMillis)throw a.Alert("this.nextFrameMillis === null"),new Error("this.nextFrameMillis === null");let t=0;for(;e>=this.nextFrameMillis;)t++,this.nextFrameMillis+=p,this.advanceFrames();t>1&&(this.tooSlowFrames+=t-1,console.info(`A total of ${this.tooSlowFrames} frames executed too slow!`))})),this.app=e,this.name=s,this.FrameCount=0,this.nextFrameMillis=null,this.frameSpeedMultiplier=1}}class es{constructor(){t(this,"cursorShowGamePos"),t(this,"e2eTest"),t(this,"settings"),t(this,"input"),t(this,"gameLoop"),t(this,"fps"),t(this,"enemies"),t(this,"gamepad"),t(this,"collisions"),t(this,"events"),t(this,"eventsCollisions"),t(this,"eventsEndOfFrame"),t(this,"eventsUi"),t(this,"eventsPoints"),t(this,"gameSpeed"),t(this,"points"),t(this,"highscore"),t(this,"gameData"),t(this,"graphics"),t(this,"ui"),t(this,"fullscreen"),t(this,"outsideHider"),t(this,"attributes"),t(this,"construct",{attributes:()=>new Yt({name:"attributes"}),cursorShowGamePos:()=>(n(),new qt),fps:()=>{const{fpsStats:e}=this.settings.settings;return n()&&e?new D({app:this,name:"fps"}):new qt},fullscreen:()=>{const{fullscreen:e}=this.settings.settings;return n()&&e?new jt({name:"fullscreen"}):new Kt({name:"mockFullscreen"})},gameSpeed:()=>{const{gameSpeedSlider:e}=this.settings.settings;return n()&&e?new G({name:"gameSpeed"}):new qt},outsideHider:()=>{const{outsideHider:e}=this.settings.settings;return n()&&e?new zt({name:"hider"}):new qt}}),t(this,"Init",(async()=>{const{attributes:e,collisions:t,enemies:s,events:i,eventsEndOfFrame:n,eventsCollisions:a,eventsPoints:o,eventsUi:r,gameLoop:h,gamepad:l,graphics:c,highscore:p,input:d,points:m,gameData:u,settings:y}=this;await u.Init(),await this.init.cursorShowGamePos(),await y.Init(),await this.e2eTest.Init({collisions:t,events:i,eventsCollisions:a,eventsPoints:o}),await d.Init({events:i}),await h.Init(),await this.init.fps(),await s.Init({attributes:e,events:i,eventsCollisions:a,eventsPoints:o,graphics:c,gameData:u,input:d,gamepad:l,settings:y}),await l.Init(),await this.collisions.Init({attributes:e,enemies:s,events:i,eventsCollisions:a}),await this.events.Init(),await this.eventsCollisions.Init(),await this.eventsPoints.Init(),await this.eventsUi.Init(),await this.init.gameSpeed(),await this.points.Init(),await this.graphics.Init({eventsEndOfFrame:n}),await this.ui.Init({events:i,eventsUi:r,gameLoop:h,highscore:p,input:d,points:m,settings:y,gameData:u}),await this.highscore.Init({gameData:u}),await this.init.fullscreen(),await this.init.outsideHider(),await this.init.attributes()})),t(this,"init",{attributes:async()=>{await this.attributes.Init()},cursorShowGamePos:async()=>{const{fullscreen:e}=this;await this.cursorShowGamePos.Init({fullscreen:e})},fps:async()=>{await this.fps.Init()},fullscreen:async()=>{await this.fullscreen.Init()},gameSpeed:async()=>{const{gameLoop:e,settings:t}=this;await this.gameSpeed.Init({gameLoop:e,settings:t})},outsideHider:async()=>{await this.outsideHider.Init()}}),this.settings=new Xt({app:this,name:"settings"});const{autoplay:e}=this.settings.settings;this.cursorShowGamePos=this.construct.cursorShowGamePos(),this.e2eTest=n()?new qt:new Ut({name:"e2e"}),this.input=n()?e?new Vt({name:"input"}):new T({name:"input"}):new Vt({name:"input"}),this.gameLoop=n()?new Zt({app:this,name:"gameLoop"}):new Qt({app:this,name:"nodeGameLoop"}),this.fps=this.construct.fps(),this.enemies=new k({name:"enemies"}),this.gamepad=new C({name:"gamePad"}),this.collisions=new P({name:"collisions"}),this.events=new F({app:this,name:"events"}),this.eventsCollisions=new F({app:this,name:"eventsCollisions"}),this.eventsEndOfFrame=new F({app:this,name:"eventsEndOfFrame"}),this.eventsUi=new F({app:this,name:"eventsUi"}),this.eventsPoints=new F({app:this,name:"eventsPoints"}),this.gameSpeed=this.construct.gameSpeed(),this.points=new W({app:this,name:"points"}),this.highscore=new class{constructor({name:e,highscores:s}){t(this,"name"),t(this,"highscores"),t(this,"gameData"),t(this,"Init",(async e=>{this.gameData=null==e?void 0:e.gameData,a.WithWindow((e=>{const t=e.localStorage.getItem(L);if(t){const e=JSON.parse(t);b(e)&&2===(null==e?void 0:e.version)&&(this.highscores=e)}else e.localStorage.setItem(L,JSON.stringify(this.highscores))}))})),t(this,"getTop1",(()=>this.highscore[0])),t(this,"getTop10",(()=>this.highscore)),t(this,"qualifiedForTop10",(e=>{let t,s=!1;for(let i=0;i<10;i++)if(e>this.highscore[i].score){s=!0,t=i;break}return{qualifiedForTop10:s,rank:t}})),t(this,"registerNewEntry",(e=>{e.score=Math.round(e.score);const{rank:t}=this.qualifiedForTop10(e.score);if(void 0===t)return;let s=this.highscore;s.splice(t,0,e),s=s.filter(((e,t)=>t<10)),this.highscores.games[this.gameData.getAndAssertActiveGame()]=s,a.WithWindow((e=>{e.localStorage.setItem(L,JSON.stringify(this.highscores))}))})),t(this,"defaultHighscore",(()=>Array(10).fill(0).map((()=>({name:"_____",score:0}))))),this.name=e,this.highscores={version:2,games:{game1:this.defaultHighscore(),game2:this.defaultHighscore()}},s&&(this.highscores=s)}get highscore(){const e=this.highscores.games[this.gameData.getAndAssertActiveGame()];if(void 0===e)throw new Error("Highscore.highscore: failed to get highscore.");return e.slice()}}({name:"highscore"}),this.gameData=new xt({name:"gameData"}),this.graphics=n()?new It({name:"graphics"}):new Jt({name:"mockGraphics"}),this.ui=n()?new Nt({name:"ui"}):new qt,this.fullscreen=this.construct.fullscreen(),this.outsideHider=this.construct.outsideHider(),this.attributes=this.construct.attributes()}}a.OnLoad((async()=>{const e=new es;await e.Init(),n()||e.gameLoop.Start()}));
